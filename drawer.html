<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ê³µê°„:ê²° - ì¸ë²¤í† ë¦¬ ë¦¬í¬íŠ¸</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #007bff; --bg: #f8fafc; --danger: #ff4d4d; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 12px; padding-bottom: 100px; }
        .main-card { background: #fff; border-radius: 28px; padding: 22px; box-shadow: 0 10px 30px rgba(0,0,0,0.06); }
        #status-msg { position: fixed; top: 0; left: 0; width: 100%; background: #0f172a; color: #fff; text-align: center; padding: 10px; font-size: 13px; font-weight: 700; display: none; z-index: 10000; }
        .media-box { width: 100%; height: 260px; background: #f1f5f9; border-radius: 20px; overflow: hidden; margin-bottom: 18px; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 2px dashed #cbd5e1; }
        .media-box img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .btn-action { background: #000; color: #fff; border: none; border-radius: 12px; padding: 15px; width: 100%; font-weight: 800; font-size: 16px; margin-bottom: 15px; cursor: pointer; }
        .item-row { background: #f0f7ff; padding: 15px; margin-bottom: 8px; border-radius: 14px; display: flex; justify-content: space-between; font-weight: 700; }
    </style>
</head>
<body>
<div id="status-msg"></div>
<div class="container">
    <div class="main-card">
        <h3 id="disp-id" style="margin: 0 0 15px 0;">ì„œë ë¡œë”© ì¤‘...</h3>
        <div class="media-box" onclick="document.getElementById('file-input').click()">
            <div id="media-wrap"><span>ğŸ“· ì‚¬ì§„ í„°ì¹˜í•´ì„œ ì—…ë¡œë“œ</span></div>
        </div>
        <button class="btn-action" onclick="startAIAnalysis()">âœ¨ AIë¡œ ë‚´ìš©ë¬¼ ë¶„ì„í•˜ê¸°</button>
        <div id="list-container"></div>
        <button style="width:100%; background:#fee2e2; color:#ef4444; border:none; padding:10px; border-radius:10px; margin-top:15px; font-weight:700;" onclick="resetAll()">ë°ì´í„° ì´ˆê¸°í™”</button>
    </div>
</div>
<input type="file" id="file-input" style="display:none" accept="image/*" onchange="uploadAndPreview(this)">

<script>
    // âš ï¸ Supabase Dashboard -> Settings -> APIì—ì„œ 'anon' í‚¤ë¥¼ ìƒˆë¡œ ë³µì‚¬í•´ì„œ ê¼­ í™•ì¸í•´ì£¼ì„¸ìš”.
    const SUPABASE_URL = 'https://tqhtggusphhcsygiitrv.supabase.co'; 
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRxaHRnZ3VzcGhoY3N5Z2lpdHJ2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEwNDMxMTMsImV4cCI6MjA4NjYxOTExM30.HXA2GbucJPkt3LFl9_JpLiwUQvI95QNEDeQWzQ9i-pc'; 
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const tag = new URLSearchParams(location.search).get('tag') || 'DRAWER001';
    let active = { url: "", items: [] };

    function showStatus(text, isError = false) {
        const bar = document.getElementById('status-msg');
        bar.innerText = text; bar.style.display = 'block';
        bar.style.background = isError ? "#ef4444" : "#0f172a";
        if(!isError && text !== "AI ë¶„ì„ ì¤‘...") setTimeout(() => bar.style.display = 'none', 3000);
    }

    async function uploadAndPreview(input) {
        const file = input.files[0]; if(!file) return;
        showStatus("ì‚¬ì§„ì„ ì €ì¥í•˜ê³  ìˆìŠµë‹ˆë‹¤...");
        
        const path = `${tag}/${Date.now()}.jpg`;
        const { error } = await _supabase.storage.from('user_uploads').upload(path, file);
        
        if(error) return showStatus("ì—…ë¡œë“œ ì‹¤íŒ¨: " + error.message, true); // ì—¬ê¸°ì„œ signature verification failed í•´ê²° ì—¬ë¶€ í™•ì¸

        const { data: { publicUrl } } = _supabase.storage.from('user_uploads').getPublicUrl(path);
        active.url = publicUrl;
        localStorage.setItem('gonggan_gyeol_url_' + tag, publicUrl);
        document.getElementById('media-wrap').innerHTML = `<img src="${publicUrl}">`;
        showStatus("ì—…ë¡œë“œ ì„±ê³µ! ë¶„ì„ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.");
    }

    async function startAIAnalysis() {
        if(!active.url) return showStatus("ì‚¬ì§„ì„ ë¨¼ì € ì˜¬ë ¤ì£¼ì„¸ìš”.", true);
        showStatus("AI ë¶„ì„ ì¤‘...", false);
        
        try {
            const img = new Image();
            img.crossOrigin = "anonymous";
            img.src = active.url;
            img.onload = async () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = 700; canvas.height = (img.height / img.width) * 700;
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                const base64 = canvas.toDataURL('image/jpeg', 0.5).split(',')[1];

                const res = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image: base64 })
                });
                const data = await res.json();
                if(!res.ok) throw new Error(data.error || "ë¶„ì„ ì‹¤íŒ¨");

                active.items = data.result.split(',').map(n => ({ cat: "AIë¶„ì„", n: n.trim(), q: 1 }));
                localStorage.setItem('gonggan_gyeol_' + tag, JSON.stringify(active.items));
                renderList();
                showStatus("ë¶„ì„ ì„±ê³µ!");
            };
        } catch(e) { showStatus("ì—ëŸ¬ ë°œìƒ: " + e.message, true); }
    }

    function renderList() {
        document.getElementById('list-container').innerHTML = active.items.map(it => `<div class="item-row"><span>${it.n}</span><span>${it.q}ê°œ</span></div>`).join('');
    }

    function resetAll() { if(confirm('ëª¨ë“  ë°ì´í„°ë¥¼ ì§€ìš¸ê¹Œìš”?')) { localStorage.clear(); location.reload(); } }

    window.onload = async () => {
        const saved = localStorage.getItem('gonggan_gyeol_' + tag);
        const url = localStorage.getItem('gonggan_gyeol_url_' + tag);
        if(saved) active.items = JSON.parse(saved);
        if(url) { active.url = url; document.getElementById('media-wrap').innerHTML = `<img src="${url}">`; }
        document.getElementById('disp-id').innerText = (tag === 'DRAWER002') ? "ì„œë 2ë²ˆ" : "ì„œë 1ë²ˆ";
        renderList();
    };
</script>
</body>
</html>
