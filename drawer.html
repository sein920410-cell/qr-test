<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ê³µê°„:ê²° - ì¸ë²¤í† ë¦¬ ë¦¬í¬íŠ¸</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root { --primary: #007bff; --bg: #f8fafc; --card: #ffffff; --item-bg: #f0f7ff; --danger: #ff4d4d; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 12px; color: #1e293b; padding-bottom: 100px; font-size: 16px; }
        .container { max-width: 500px; margin: 0 auto; }
        .main-card { background: var(--card); border-radius: 28px; padding: 22px; box-shadow: 0 10px 30px rgba(0,0,0,0.06); border: 1px solid rgba(0,0,0,0.05); }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .title-badge { background: #0f172a; color: #fff; padding: 8px 16px; border-radius: 100px; font-size: 13px; font-weight: 700; }
        .btn-rescan { background: #f1f5f9; border: 1px solid #e2e8f0; border-radius: 10px; padding: 8px 14px; font-size: 12px; color: #475569; font-weight: 800; cursor: pointer; }
        .media-box { width: 100%; height: 260px; aspect-ratio: 4 / 3; background: #f1f5f9; border-radius: 20px; overflow: hidden; margin-bottom: 18px; display: flex; align-items: center; justify-content: center; cursor: zoom-in; }
        .media-box img, .media-box video { max-width: 100%; max-height: 100%; object-fit: contain; }
        .search-input { width: 100%; padding: 15px; border: 2px solid var(--primary); border-radius: 12px; box-sizing: border-box; font-size: 16px; margin-bottom: 15px; outline: none; }
        .add-area { display: flex; justify-content: flex-end; margin-bottom: 10px; padding-right: 5px; }
        .btn-add { background: var(--primary); color: #fff; border: none; border-radius: 8px; padding: 8px 16px; font-size: 13px; font-weight: 800; cursor: pointer; box-shadow: 0 2px 8px rgba(0,123,255,0.2); }
        .list-header { background: #f1f5f9; border-radius: 14px; margin-bottom: 12px; padding: 14px 18px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .list-header span { font-size: 14px; font-weight: 800; color: #475569; }
        .cat-group { background: var(--card); border-radius: 16px; margin-bottom: 10px; border: 1px solid #e2e8f0; overflow: hidden; }
        .cat-head { padding: 18px; display: flex; justify-content: space-between; font-weight: 800; font-size: 16px; cursor: pointer; align-items: center; }
        .cat-body { display: none; padding: 10px; background: #fafafa; border-top: 1px solid #f1f5f9; }
        .arr { font-size: 18px; color: #64748b; transition: transform 0.3s; display: inline-block; font-family: serif; font-weight: bold; }
        .item-row { background: var(--item-bg); border-radius: 14px; margin-bottom: 8px; padding: 12px; border: 1px solid #e0f0ff; }
        .item-name { font-size: 15px; font-weight: 700; color: #334155; display: block; margin-bottom: 12px; }
        .item-footer { display: flex; justify-content: space-between; align-items: center; }
        .item-tools { display: flex; gap: 6px; }
        .btn-tool { background: #fff; border: 1px solid #d1e9ff; border-radius: 6px; padding: 6px 10px; font-size: 11px; font-weight: 700; color: #64748b; cursor: pointer; }
        .btn-delete { color: var(--danger); border-color: #ffdada; }
        .qty-controls { display: flex; align-items: center; gap: 6px; background: #fff; padding: 4px 6px; border-radius: 10px; border: 1px solid #d1e9ff; }
        .btn-qty { border: none; background: #e0f0ff; color: var(--primary); width: 24px; height: 24px; border-radius: 6px; font-weight: 900; cursor: pointer; }
        .qty-input { width: 35px; border: none; text-align: center; font-size: 13px; font-weight: 800; outline: none; background: transparent; }
        .chat-btn { position: fixed; bottom: 20px; right: 20px; background: #000; color: #fff; border: none; border-radius: 50px; padding: 16px 26px; font-weight: 800; font-size: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); cursor: pointer; z-index: 1000; }
        .chat-window { display: none; position: fixed; bottom: 90px; right: 20px; width: 320px; height: 400px; background: #fff; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); flex-direction: column; overflow: hidden; z-index: 1001; }
        .chat-header { background: #000; color: #fff; padding: 15px; font-weight: 800; font-size: 14px; display: flex; justify-content: space-between; }
        .chat-messages { flex: 1; padding: 15px; overflow-y: auto; font-size: 14px; background: #f8fafc; }
        .msg { margin-bottom: 10px; padding: 10px; border-radius: 12px; max-width: 80%; }
        .msg.bot { background: #e2e8f0; align-self: flex-start; }
        .chat-input-area { padding: 10px; border-top: 1px solid #eee; display: flex; }
        .chat-input { flex: 1; border: 1px solid #ddd; padding: 8px; border-radius: 8px; outline: none; }
        .modal { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); align-items: center; justify-content: center; }
        .modal-img { max-width: 98%; max-height: 98%; object-fit: contain; }
        .empty-state { text-align: center; padding: 40px 20px; color: #94a3b8; font-size: 15px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-card">
            <div class="header">
                <div class="title-badge" id="disp-id">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                <button class="btn-rescan" onclick="analyzeImage()">ğŸ“¸ ì¬ì´¬ì˜ AI ë¶„ì„</button>
            </div>
            <div class="media-box" onclick="openFull()">
                <div id="media-wrap" style="width:100%; height:100%; display:flex; align-items:center; justify-content:center;"></div>
            </div>
            <input type="text" id="find-box" class="search-input" placeholder="ë¬´ì—‡ì„ ì°¾ìœ¼ì‹œë‚˜ìš”?" oninput="updateList()">
            <div class="add-area">
                <button class="btn-add" onclick="addItem()">+ ë¬¼í’ˆ ì¶”ê°€</button>
            </div>
            <div class="list-header" onclick="toggleAll()">
                <span>ğŸ“¦ ë³´ê´€ ë¬¼í’ˆ ì „ì²´ ëª©ë¡</span>
                <span id="all-arr-icon" class="arr">â€º</span>
            </div>
            <div id="list-container"></div>
        </div>
    </div>

    <button class="chat-btn" onclick="toggleChat()">âœ¨ ê²°ì—ê²Œ ë¬»ê¸°</button>
    <div id="chat-window" class="chat-window">
        <div class="chat-header"><span>ë¹„ì„œ 'ê²°'</span><span style="cursor:pointer" onclick="toggleChat()">âœ•</span></div>
        <div class="chat-messages" id="chat-messages">
            <div class="msg bot">ì•ˆë…•í•˜ì„¸ìš”! ì‚¬ì§„ì„ ì°ì–´ ë¬¼í’ˆì„ ìë™ ë“±ë¡í•´ë³´ì„¸ìš”!</div>
        </div>
        <div class="chat-input-area">
            <input type="text" class="chat-input" placeholder="ë©”ì‹œì§€ ì…ë ¥..." onkeydown="if(event.key==='Enter') sendMsg(this)">
        </div>
    </div>

    <div id="full-view" class="modal" onclick="this.style.display='none'">
        <div id="modal-body" style="width:100%; height:100%; display:flex; align-items:center; justify-content:center;"></div>
    </div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const tag = (params.get('tag') || 'DRAWER001').toUpperCase();
        let isAllOpen = false;
        let openCats = {};
        const db = {
            "DRAWER001": { title: "ì„œë 1ë²ˆ", url: "https://tqhtggusphhcsygiitrv.supabase.co/storage/v1/object/public/user_uploads/DRAWER001/drawer1.mp4.mp4", items: [] },
            "DRAWER002": { title: "ì„œë 2ë²ˆ", url: "https://tqhtggusphhcsygiitrv.supabase.co/storage/v1/object/public/user_uploads/DRAWER001/drawer2.jpg.jpg", items: [] }
        };
        let active = db[tag] || db["DRAWER001"];

        function loadSavedData() {
            const saved = localStorage.getItem('gonggan_gyeol_' + tag);
            if (saved) {
                active.items = JSON.parse(saved);
            } else {
                // âœ… ë¹ˆ ëª©ë¡ìœ¼ë¡œ ì‹œì‘ (ë”ë¯¸ ë°ì´í„° ì™„ì „ ì‚­ì œ)
                active.items = [];
            }
        }

        function saveData() { localStorage.setItem('gonggan_gyeol_' + tag, JSON.stringify(active.items)); }

        // ğŸ”¥ API í™œì„±í™”: ì‚¬ì§„ ë¶„ì„
        async function analyzeImage() {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/*';
            fileInput.onchange = async (e) => {
                const formData = new FormData();
                formData.append('image', e.target.files[0]);
                formData.append('tag', tag);

                try {
                    const res = await fetch('/api/analyze', { method: 'POST', body: formData });
                    const data = await res.json();
                    
                    if (data.success) {
                        data.items.forEach(item => active.items.push(item));
                        saveData();
                        updateList();
                        alert(`${data.items.length}ê°œ ë¬¼í’ˆ ìë™ ì¶”ê°€! âœ¨`);
                    } else {
                        alert('ë¶„ì„ ì˜¤ë¥˜: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                    }
                } catch(err) {
                    alert('ì—°ê²° ì˜¤ë¥˜: ' + err.message + '\nF12 ì½˜ì†” í™•ì¸!');
                }
            };
            fileInput.click();
        }

        // ğŸ”¥ API í™œì„±í™”: ì‹¤ì‹œê°„ ì±„íŒ…
        async function sendMsg(input) {
            if(!input.value.trim()) return;
            const msgs = document.getElementById('chat-messages');
            const userMsg = `<div class="msg" style="background:#007bff;color:#fff;align-self:flex-end;margin-left:auto;padding:10px;border-radius:12px;margin-bottom:10px;">${input.value}</div>`;
            msgs.innerHTML += userMsg;
            
            msgs.innerHTML += '<div class="msg bot" style="background:#e2e8f0;">ğŸ¤– ë¶„ì„ ì¤‘...</div>';
            msgs.scrollTop = msgs.scrollHeight;

            try {
                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ message: input.value, tag: tag })
                });
                const data = await res.json();
                
                const lastMsg = msgs.querySelector('.msg:last-child');
                if (data.reply) {
                    lastMsg.innerHTML = data.reply;
                } else {
                    lastMsg.innerHTML = 'ì‘ë‹µ ì˜¤ë¥˜! ì½˜ì†” í™•ì¸.';
                }
            } catch(err) {
                const lastMsg = msgs.querySelector('.msg:last-child');
                lastMsg.innerHTML = 'ì±„íŒ… ì—°ê²° ì‹¤íŒ¨! F12 í™•ì¸í•˜ì„¸ìš”.';
                console.error('Chat error:', err);
            }
            
            input.value = ''; 
            msgs.scrollTop = msgs.scrollHeight;
        }

        window.onload = () => {
            loadSavedData();
            document.getElementById('disp-id').innerText = active.title;
            const wrap = document.getElementById('media-wrap');
            if (active.url.includes('.mp4')) wrap.innerHTML = `<video src="${active.url}" autoplay loop muted playsinline></video>`;
            else wrap.innerHTML = `<img src="${active.url}">`;
            updateList();
        };

        function updateList() {
            const word = document.getElementById('find-box').value.trim().toLowerCase();
            const container = document.getElementById('list-container');
            
            // ë¹ˆ ëª©ë¡ì¼ ë•Œ ì•ˆë‚´ë¬¸ í‘œì‹œ
            if (active.items.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        ğŸ“· ì•„ì§ ë“±ë¡ëœ ë¬¼í’ˆì´ ì—†ìŠµë‹ˆë‹¤.<br>
                        <strong>"ğŸ“¸ ì¬ì´¬ì˜ AI ë¶„ì„" ë²„íŠ¼</strong>ìœ¼ë¡œ ì‚¬ì§„ì„ ì°ì–´ ìë™ ë“±ë¡í•˜ì„¸ìš”!
                    </div>
                `;
                return;
            }

            container.innerHTML = '';
            const filtered = active.items.filter(i => i.n.toLowerCase().includes(word));
            const cats = [...new Set(filtered.map(i => i.cat))];

            cats.forEach(c => {
                const list = filtered.filter(i => i.cat === c);
                const div = document.createElement('div');
                div.className = 'cat-group';
                const isOpen = word || isAllOpen || openCats[c];
                
                div.innerHTML = `
                    <div class="cat-head" onclick="toggle('${c}', this)">
                        <span>${c} (${list.length})</span>
                        <span class="arr" style="transform: rotate(${isOpen ? '90deg' : '0deg'})">â€º</span>
                    </div>
                    <div class="cat-body" style="display: ${isOpen ? 'block' : 'none'}">
                        ${list.map(item => {
                            const globalIdx = active.items.indexOf(item);
                            return `
                                <div class="item-row">
                                    <span class="item-name">${item.n}</span>
                                    <div class="item-footer">
                                        <div class="item-tools">
                                            <button class="btn-tool" onclick="editItem(${globalIdx})">ìˆ˜ì •</button>
                                            <button class="btn-tool btn-delete" onclick="deleteItem(${globalIdx})">ì‚­ì œ</button>
                                        </div>
                                        <div class="qty-controls">
                                            <button class="btn-qty" onclick="changeQty(${globalIdx}, -1, event)">-</button>
                                            <input type="number" class="qty-input" value="${item.q}" onchange="inputQty(${globalIdx}, this.value)">
                                            <span style="font-size:11px; font-weight:800; color:#94a3b8;">EA</span>
                                            <button class="btn-qty" onclick="changeQty(${globalIdx}, 1, event)">+</button>
                                        </div>
                                    </div>
                                </div>`;
                        }).join('')}
                    </div>`;
                container.appendChild(div);
            });
            document.getElementById('all-arr-icon').style.transform = isAllOpen ? 'rotate(90deg)' : 'rotate(0deg)';
        }

        function addItem() {
            const name = prompt("ì¶”ê°€í•  ë¬¼í’ˆ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”."); if (!name) return;
            const cat = prompt("ì¹´í…Œê³ ë¦¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”.", "ê¸°íƒ€"); if (!cat) return;
            active.items.push({ cat: cat, n: name, q: 1 });
            openCats[cat] = true; saveData(); updateList();
        }

        function editItem(idx) {
            const item = active.items[idx];
            const newName = prompt("ìƒˆë¡œìš´ ë¬¼í’ˆ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.", item.n); if (!newName) return;
            const newCat = prompt("ì¹´í…Œê³ ë¦¬ë¥¼ ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?", item.cat); if (!newCat) return;
            item.n = newName; item.cat = newCat;
            openCats[newCat] = true; saveData(); updateList();
        }

        function deleteItem(idx) {
            if (confirm(`${active.items[idx].n} ë¬¼í’ˆì„ ì •ë§ ì‚­ì œí• ê¹Œìš”?`)) {
                active.items.splice(idx, 1); saveData(); updateList();
            }
        }

        function changeQty(idx, val, e) {
            e.stopPropagation(); active.items[idx].q = Math.max(0, active.items[idx].q + val);
            saveData(); updateList();
        }

        function inputQty(idx, val) {
            active.items[idx].q = Math.max(0, parseInt(val) || 0);
            saveData(); updateList();
        }

        function toggleChat() {
            const win = document.getElementById('chat-window');
            win.style.display = (win.style.display === 'flex') ? 'none' : 'flex';
        }

        function toggleAll() { isAllOpen = !isAllOpen; openCats = {}; updateList(); }

        function toggle(catName, h) {
            const b = h.nextElementSibling;
            const a = h.querySelector('.arr');
            const show = b.style.display === 'none' || b.style.display === '';
            b.style.display = show ? 'block' : 'none';
            a.style.transform = show ? 'rotate(90deg)' : 'rotate(0deg)';
            openCats[catName] = show;
        }

        function openFull() {
            const m = document.getElementById('full-view');
            const b = document.getElementById('modal-body');
            m.style.display = "flex";
            if (active.url.includes('.mp4')) b.innerHTML = `<video src="${active.url}" controls autoplay class="modal-img"></video>`;
            else b.innerHTML = `<img src="${active.url}" class="modal-img">`;
        }
    </script>
</body>
</html>
