<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>공간:결 - 서랍 관리</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="style.css">
</head>
<body>

<div id="loadingOverlay" class="loading-overlay">
  <div class="spinner"></div>
  <p class="loading-text">비서 <b>'결'</b>이 서랍을 분석하고 있어요...</p>
</div>

<div class="drawer-header">
  <h2 id="drawer-title">서랍</h2>
  <button class="add-btn" onclick="document.getElementById('fileInput').click()">+</button>
  <input type="file" id="fileInput" hidden accept="image/*,video/*" onchange="handleAnalyze(this.files[0])">
</div>

<div class="search-container" style="margin-top: 10px;">
  <input type="text" id="drawer-search" class="search-box" placeholder="이 서랍에서 검색">
  <div id="item-list">
    <p id="empty-msg" style="text-align:center; color:#888; margin-top:40px;">이 서랍에 아직 등록된 물건이 없습니다.<br>사진을 찍거나 직접 입력해 보세요.</p>
  </div>
</div>

<script>
const urlParams = new URLSearchParams(window.location.search);
const tag = urlParams.get('tag') || 'DRAWER001';
document.getElementById('drawer-title').innerText = tag;

async function handleAnalyze(file) {
  if (!file) return;

  // 1. 용량 체크 (Vercel 4.5MB 제한) [cite: 2026-02-23]
  const MAX_SIZE = 4.5 * 1024 * 1024;
  if (file.size > MAX_SIZE) {
    alert("파일이 너무 커서 비서 '결'이 분석할 수 없어요! 영상은 5초 내외로 촬영해 주세요.");
    return;
  }

  // 2. 로딩 시작
  document.getElementById('loadingOverlay').style.display = 'flex';

  try {
    const formData = new FormData();
    formData.append('file', file);
    formData.append('tag', tag);

    const resp = await fetch('/api/analyze', { method: 'POST', body: formData });
    const data = await resp.json();

    if (data.error) throw new Error(data.error);
    
    // 성공 시 목록 업데이트 로직 (세인 님의 기존 저장 로직 연결)
    alert("비서 '결'이 물건 등록을 완료했습니다!");
    location.reload(); 

  } catch (err) {
    alert("오류 발생: " + err.message);
  } finally {
    // 3. 로딩 종료
    document.getElementById('loadingOverlay').style.display = 'none';
  }
}
</script>
</body>
</html>
