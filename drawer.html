<!-- drawer.html (client) -->
<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ê³µê°„:ê²° - ê´€ë¦¬</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div id="app">
    <h3 id="disp-id">ì„œë í™•ì¸ ì¤‘...</h3>
    <input type="file" id="camera-input" accept="image/*" capture="environment" onchange="handleFile(this)">
    <button onclick="document.getElementById('camera-input').click()">ì‚¬ì§„ ì—…ë¡œë“œ</button>

    <button onclick="toggleChat()">ê²°ì—ê²Œ ë¬»ê¸°</button>
    <div id="chat-window" style="display:none">
      <div id="chat-messages"></div>
      <input id="chat-field" placeholder="ë©”ì‹œì§€ ì…ë ¥..." onkeydown="if(event.key==='Enter') sendMsg()">
      <button onclick="sendMsg()">ì „ì†¡</button>
    </div>
  </div>

<script>
  // í™˜ê²½ê°’
  const SUPABASE_URL = 'https://tqhtggusphhcsygiitrv.supabase.co';
  const SUPABASE_ANON_KEY = 'sb_publishable_lJeKpO0aRv9mTBE1qnbkow_JqTmhnHQ';
  const BUCKET = 'user_uploads';  // ğŸ”¥ BUCKET ë³€ìˆ˜ ì¶”ê°€ (Supabase ë²„í‚·ëª…)
  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const tag = (new URLSearchParams(window.location.search).get('tag') || 'DRAWER001').toUpperCase();
  let chatSubscribed = false;

  async function handleFile(input) {
    const file = input.files[0];
    if (!file) return alert("íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”");
    
    // ğŸ”¥ ì•ˆì „í•œ íŒŒì¼ëª… ìƒì„± (ê³µë°±â†’_, íŠ¹ìˆ˜ë¬¸ì ì œê±°)
    const safeName = file.name.replace(/[^a-zA-Z0-9.-]/g, '_');
    const fName = `photos/${Date.now()}_${safeName}`;
    
    // 1) ë¸Œë¼ìš°ì €ì—ì„œ ì—…ë¡œë“œ (anon í‚¤ë¡œ)
    console.log("ì—…ë¡œë“œ ì¤‘:", fName);  // ë””ë²„ê¹…ìš©
    const { data: upData, error: upErr } = await supabaseClient.storage
      .from(BUCKET)
      .upload(fName, file, { upsert: true });
      
    if (upErr) { 
      console.error("ì—…ë¡œë“œ ì—ëŸ¬:", upErr); 
      return alert("ì—…ë¡œë“œ ì‹¤íŒ¨: " + upErr.message); 
    }
    
    const filePath = upData?.path || fName;
    console.log("ì—…ë¡œë“œ ì„±ê³µ:", filePath);  // ë””ë²„ê¹…ìš©

    // 2) ì„œë²„ì— filePathë§Œ ì „ì†¡
    try {
      const r = await fetch('/api/analyze', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ filePath })
      });
      const json = await r.json();
      if (json.items) {
        alert("âœ… ì¸ì‹ì™„ë£Œ: " + json.items.join(", "));
      } else {
        alert("âŒ ì¸ì‹ ì‹¤íŒ¨: " + (json.error || JSON.stringify(json)));
      }
    } catch (e) {
      console.error(e);
      alert("ì„œë²„ í˜¸ì¶œ ì‹¤íŒ¨");
    }
    input.value = '';  // ì…ë ¥ ì´ˆê¸°í™”
  }

  async function setupChatSubscription() {
    if (chatSubscribed) return;
    if (typeof supabaseClient.channel !== 'function') {
      chatSubscribed = true;
      return;
    }
    await supabaseClient.channel('public:chat_messages')
      .on('postgres_changes', { event:'INSERT', schema:'public', table:'chat_messages', filter:`tag=eq.${tag}` }, payload => {
        const m = payload.new;
        addMsg(m.sender === 'bot' ? 'bot' : 'user', m.content);
      }).subscribe();
    const { data } = await supabaseClient.from('chat_messages').select('*').eq('tag', tag).order('created_at', {ascending:true}).limit(200);
    if (data) data.forEach(d => addMsg(d.sender === 'bot' ? 'bot' : 'user', d.content));
    chatSubscribed = true;
  }

  function toggleChat(){
    const w = document.getElementById('chat-window');
    const show = w.style.display !== 'flex';
    w.style.display = show ? 'flex' : 'none';
    if (show) setupChatSubscription();
  }

  function addMsg(type, text){
    const box = document.getElementById('chat-messages');
    const el = document.createElement('div'); 
    el.innerText = (type==='bot' ? 'ê²°: ' : 'ë‚˜: ') + text;
    box.appendChild(el);
    box.scrollTop = box.scrollHeight;
  }

  async function sendMsg(){
    const f = document.getElementById('chat-field'); 
    const txt = f.value.trim(); 
    if(!txt) return;
    try {
      await fetch('/api/chat', { 
        method:'POST', 
        headers:{'Content-Type':'application/json'}, 
        body: JSON.stringify({ message: txt, inventory: "[]", tag }) 
      });
      f.value = '';
    } catch(e) { 
      console.error(e); 
      alert("ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨"); 
    }
  }
</script>
</body>
</html>
