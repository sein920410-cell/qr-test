<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ê³µê°„:ê²° - í†µí•© ë¦¬í¬íŠ¸</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #007bff; --bg: #f8fafc; --card: #ffffff; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 12px; padding-bottom: 100px; }
        .main-card { background: var(--card); border-radius: 28px; padding: 22px; box-shadow: 0 10px 30px rgba(0,0,0,0.06); }
        #status-msg { position: fixed; top: 0; left: 0; width: 100%; background: #0f172a; color: #fff; text-align: center; padding: 12px; font-size: 13px; font-weight: 700; display: none; z-index: 10000; }
        .media-box { width: 100%; height: 260px; background: #f1f5f9; border-radius: 20px; overflow: hidden; margin-bottom: 15px; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 2px dashed #cbd5e1; }
        .media-box img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .btn-action { background: #000; color: #fff; border: none; border-radius: 12px; padding: 15px; width: 100%; font-weight: 800; margin-bottom: 15px; cursor: pointer; }
        .item-row { background: #f0f7ff; padding: 15px; margin-bottom: 8px; border-radius: 12px; display: flex; justify-content: space-between; font-weight: 700; }
        .chat-btn { position: fixed; bottom: 20px; right: 20px; background: #000; color: #fff; border: none; border-radius: 50px; padding: 15px 25px; font-weight: 800; cursor: pointer; }
    </style>
</head>
<body>
<div id="status-msg"></div>
<div class="container">
    <div class="main-card">
        <div class="media-box" onclick="document.getElementById('file-input').click()">
            <div id="media-wrap"><span>ğŸ“· ì‚¬ì§„ í„°ì¹˜í•´ì„œ ì—…ë¡œë“œ</span></div>
        </div>
        <button class="btn-action" onclick="startAIAnalysis()">âœ¨ AIë¡œ ë‚´ìš©ë¬¼ ë¶„ì„í•˜ê¸°</button>
        <div id="list-container"></div>
        <button style="width:100%; background:#fee2e2; color:#ef4444; border:none; padding:10px; border-radius:10px; margin-top:15px; font-weight:700;" onclick="if(confirm('ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í• ê¹Œìš”?')){localStorage.clear(); location.reload();}">ì „ì²´ ì´ˆê¸°í™”</button>
    </div>
</div>
<button class="chat-btn" onclick="toggleChat()">âœ¨ ê²°ì—ê²Œ ë¬»ê¸°</button>
<input type="file" id="file-input" style="display:none" accept="image/*" onchange="uploadAndPreview(this)">

<script>
    const SUPABASE_URL = 'https://tqhtggusphhcsygiitrv.supabase.co'; 
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRxaHRnZ3VzcGhoY3N5Z2lpdHJ2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzExNDMxMTMsImV4cCI6MjA4NjcyOTExM30.HXA2GbucJPkt3LFl9_JpLiwUQvI95QNEDeQWzQ9i-pc';
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const tag = new URLSearchParams(location.search).get('tag') || 'DRAWER001';
    let currentImgUrl = "";

    function showStatus(text, isError = false) {
        const bar = document.getElementById('status-msg');
        bar.innerText = text; bar.style.display = 'block';
        bar.style.background = isError ? "#ef4444" : "#0f172a";
        if(!isError && text !== "AI ë¶„ì„ ì¤‘...") setTimeout(() => bar.style.display = 'none', 3000);
    }

    async function uploadAndPreview(input) {
        const file = input.files[0]; if(!file) return;
        showStatus("ì‚¬ì§„ ì „ì†¡ ì¤‘...");
        const path = `${tag}/${Date.now()}.jpg`;
        const { error } = await _supabase.storage.from('user_uploads').upload(path, file);
        if(error) return showStatus("ì—…ë¡œë“œ ì—ëŸ¬: " + error.message, true);
        const { data: { publicUrl } } = _supabase.storage.from('user_uploads').getPublicUrl(path);
        currentImgUrl = publicUrl;
        localStorage.setItem('gonggan_gyeol_url_' + tag, publicUrl);
        document.getElementById('media-wrap').innerHTML = `<img src="${publicUrl}">`;
        showStatus("ì—…ë¡œë“œ ì™„ë£Œ!");
    }

    async function startAIAnalysis() {
        if(!currentImgUrl) return showStatus("ë¨¼ì € ì‚¬ì§„ì„ ë“±ë¡í•´ì£¼ì„¸ìš”.", true);
        showStatus("AI ë¶„ì„ ì¤‘...", false);
        try {
            const img = new Image();
            img.crossOrigin = "anonymous"; // [CORS í­íƒ„ ì œê±°]
            img.src = currentImgUrl;
            img.onload = async () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                // [ìš©ëŸ‰ í­íƒ„ ì œê±°] ê°€ë¡œ 700pxë¡œ ì••ì¶•
                canvas.width = 700; canvas.height = (img.height / img.width) * 700;
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                const base64 = canvas.toDataURL('image/jpeg', 0.5).split(',')[1];

                const res = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image: base64 })
                });
                const data = await res.json();
                if(!res.ok) throw new Error(data.error);

                const items = data.result.split(',').map(n => ({ n: n.trim(), q: 1 }));
                localStorage.setItem('gonggan_gyeol_' + tag, JSON.stringify(items));
                renderList(items);
                showStatus("ë¶„ì„ ì„±ê³µ!");
            };
            img.onerror = () => { throw new Error("ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); };
        } catch(e) { showStatus("ì—ëŸ¬: " + e.message, true); }
    }

    function renderList(items) {
        document.getElementById('list-container').innerHTML = items.map(it => `<div class="item-row"><span>${it.n}</span><span>${it.q}ê°œ</span></div>`).join('');
    }

    function toggleChat() { alert("ì±„íŒ… ê¸°ëŠ¥ì€ ë¶„ì„ ì™„ë£Œ í›„ ìë™ìœ¼ë¡œ ì—°ë™ë©ë‹ˆë‹¤."); }

    window.onload = () => {
        const saved = localStorage.getItem('gonggan_gyeol_' + tag);
        const url = localStorage.getItem('gonggan_gyeol_url_' + tag);
        if(saved) renderList(JSON.parse(saved));
        if(url) { currentImgUrl = url; document.getElementById('media-wrap').innerHTML = `<img src="${url}">`; }
    };
</script>
</body>
</html>
