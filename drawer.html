// drawer.html: handleFile 대체
async function handleFile(input){
  const file = input.files[0];
  if(!file) return;
  const status = document.getElementById('disp-id');
  status.innerText = '업로드 중...';

  try {
    const fName = `${Date.now()}_${file.name}`;
    // 1) 업로드 (클라이언트는 anon key로 업로드만 함)
    const { data: upData, error: upErr } = await supabaseClient.storage.from(BUCKET).upload(fName, file, { upsert: true });
    if (upErr) throw upErr;

    // 2) 서버에 filePath(경로)만 보냄 — 서버가 signed URL 생성 후 Gemini 호출
    const filePath = upData?.path || fName; // supabase 업로드 응답에서 path 확인
    const res = await fetch('/api/analyze', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ filePath })
    });

    const json = await res.json();
    if (json.items && Array.isArray(json.items)) {
      json.items.forEach(n => activeItems.push({ cat: '신규 인식', n, q: 1 }));
      localStorage.setItem('gonggan_gyeol_' + tag, JSON.stringify(activeItems));
      render();
      status.innerText = '분석 완료';
    } else {
      throw new Error(json.error || '인식 실패');
    }
  } catch (e) {
    console.error(e);
    status.innerText = '에러: ' + (e.message || e);
    status.style.color = 'red';
  } finally {
    setTimeout(()=>{ document.getElementById('disp-id').innerText = (tag==='DRAWER002')?'서랍 2번':'서랍 1번'; }, 1500);
  }
}
