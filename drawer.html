<!-- drawer.html -->
<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ê³µê°„:ê²° - ê´€ë¦¬</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  /* ìµœì†Œ ìŠ¤íƒ€ì¼ â€” í•„ìš”í•˜ë©´ ê¸°ì¡´ ìŠ¤íƒ€ì¼ ë¶™ì—¬ë„£ì–´ë„ ë¨ */
  body{font-family:-apple-system, sans-serif;background:#f8fafc;margin:0;padding:16px}
  .card{background:#fff;padding:18px;border-radius:16px;box-shadow:0 8px 20px rgba(0,0,0,.06);max-width:540px;margin:0 auto}
  .upload-tools{display:flex;gap:8px;margin-bottom:12px}
  .btn{padding:12px;border-radius:12px;border:none;cursor:pointer}
  .primary{background:#0b79ff;color:#fff}
  .chat-btn{position:fixed;right:20px;bottom:20px;background:#000;color:#fff;padding:12px 18px;border-radius:28px}
  .chat-window{display:none;position:fixed;right:20px;bottom:90px;width:320px;height:420px;background:#fff;border-radius:12px;padding:0;box-shadow:0 10px 30px rgba(0,0,0,.15);overflow:hidden;flex-direction:column}
  .chat-header{background:#000;color:#fff;padding:12px;font-weight:800;display:flex;justify-content:space-between}
  .chat-messages{padding:12px;overflow:auto;height:320px;display:flex;flex-direction:column;gap:8px;background:#f8fafc}
  .chat-input-area{display:flex;padding:10px;border-top:1px solid #eee}
  .chat-input{flex:1;padding:8px;border-radius:10px;border:1px solid #ddd}
  .msg{padding:10px;border-radius:12px;max-width:80%}
  .bot{background:#eef3fb;align-self:flex-start}
  .user{background:#0b79ff;color:#fff;align-self:flex-end}
</style>
</head>
<body>
<div class="card">
  <h3 id="disp-id">ì„œë í™•ì¸ ì¤‘...</h3>
  <div class="upload-tools">
    <button class="btn primary" onclick="document.getElementById('camera-input').click()">ğŸ“¸ ì¦‰ì‹œ ì´¬ì˜</button>
    <button class="btn" onclick="document.getElementById('album-input').click()">ğŸ–¼ ì•¨ë²” ì„ íƒ</button>
  </div>

  <input type="file" id="camera-input" accept="image/*" capture="environment" style="display:none" onchange="handleFile(this)">
  <input type="file" id="album-input" accept="image/*" style="display:none" onchange="handleFile(this)">

  <input id="find-box" placeholder="ê²€ìƒ‰ í›„ ì—”í„°" style="width:100%;padding:12px;border-radius:10px;border:2px solid #dfefff;margin-top:8px">
  <div id="list-container" style="margin-top:12px"></div>
</div>

<button class="chat-btn" onclick="toggleChat()">âœ¨ ê²°ì—ê²Œ ë¬»ê¸°</button>

<div id="chat-window" class="chat-window" style="display:flex;flex-direction:column">
  <div class="chat-header"><span>ë¹„ì„œ 'ê²°'</span><span style="cursor:pointer" onclick="toggleChat()">âœ•</span></div>
  <div id="chat-messages" class="chat-messages"></div>
  <div class="chat-input-area">
    <input id="chat-field" class="chat-input" placeholder="ë©”ì‹œì§€ ì…ë ¥..." onkeydown="if(event.key==='Enter') sendMsg()">
    <button style="margin-left:8px" onclick="sendMsg()">ì „ì†¡</button>
  </div>
</div>

<script>
  // ============= ì„¤ì •ê°’(ìˆ˜ì • í•„ìš”) =============
  const SUPABASE_URL = 'https://tqhtggusphhcsygiitrv.supabase.co'; // ë„¤ ê°’
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRxaHRnZ3VzcGhoY3N5Z2lpdHJ2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEwNDMxMTMsImV4cCI6MjA4NjYxOTExM30.HXA2GbucJPkt3LFl9_JpLiwUQvI95QNEDeQWzQ9i-pc'; // Supabase ê³µê°œ(anon)í‚¤ (ë¸Œë¼ìš°ì €ì— ì‚¬ìš©)
  const BUCKET = 'user_uploads';

  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  const tag = (new URLSearchParams(window.location.search).get('tag') || 'DRAWER001').toUpperCase();
  let activeItems = [];
  let chatSubscribed = false;

  window.onload = async () => {
    document.getElementById('disp-id').innerText = (tag==='DRAWER002') ? 'ì„œë 2ë²ˆ' : 'ì„œë 1ë²ˆ';
    const s = localStorage.getItem('gonggan_gyeol_'+tag);
    activeItems = s ? JSON.parse(s) : [{cat:'ê¸°íƒ€',n:'ìƒ˜í”Œ',q:1}];
    render();
  };

  function render(){
    const cont = document.getElementById('list-container');
    cont.innerHTML = '';
    const cats = [...new Set(activeItems.map(i=>i.cat))];
    cats.forEach(c=>{
      const list = activeItems.filter(i=>i.cat===c);
      const el = document.createElement('div');
      el.style.marginBottom='10px';
      el.innerHTML = `<div style="font-weight:800">${c} (${list.length})</div>` + list.map(it=>`<div style="background:#f0f7ff;padding:12px;border-radius:10px;margin-top:8px;position:relative;"><div style="font-weight:800">${it.n}</div><div style="position:absolute;right:12px;top:12px;background:#0b79ff;color:#fff;padding:4px 8px;border-radius:8px">${it.q} EA</div></div>`).join('');
      cont.appendChild(el);
    });
  }

  function saveAndRender(){ localStorage.setItem('gonggan_gyeol_'+tag, JSON.stringify(activeItems)); render(); }

  // =========== íŒŒì¼ ì—…ë¡œë“œ & ë¶„ì„ (í•µì‹¬ ë³€ê²½) ===========
  async function handleFile(input){
    const file = input.files[0]; if(!file) return;
    const status = document.getElementById('disp-id');
    status.innerText = 'ì—…ë¡œë“œ ì¤‘...';

    try {
      const fName = `${Date.now()}_${file.name}`;
      // 1) ì—…ë¡œë“œ (ë¸Œë¼ìš°ì €ëŠ” anon keyë¡œ ì—…ë¡œë“œë§Œ)
      const { data: upData, error: upErr } = await supabaseClient.storage.from(BUCKET).upload(fName, file, { upsert: true });
      if (upErr) throw upErr;

      // upData.path ë˜ëŠ” fName ì „ë‹¬
      const filePath = upData?.path || fName;

      // 2) ì„œë²„ì— filePathë§Œ ì „ë‹¬ -> ì„œë²„ê°€ signedUrl ìƒì„± + Gemini í˜¸ì¶œ
      const r = await fetch('/api/analyze', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ filePath })
      });

      const json = await r.json();
      if (json.items && Array.isArray(json.items)) {
        json.items.forEach(n => activeItems.push({ cat:'ì‹ ê·œ ì¸ì‹', n, q:1 }));
        saveAndRender();
        status.innerText = 'ë¶„ì„ ì™„ë£Œ';
      } else {
        throw new Error(json.error || 'ì¸ì‹ ì‹¤íŒ¨');
      }
    } catch (e) {
      console.error(e);
      status.innerText = 'ì—ëŸ¬: ' + (e.message || e);
      status.style.color = 'red';
    } finally {
      setTimeout(()=>{ document.getElementById('disp-id').innerText = (tag==='DRAWER002')?'ì„œë 2ë²ˆ':'ì„œë 1ë²ˆ'; }, 1200);
    }
  }

  // =========== ì±„íŒ… (êµ¬ë…ì€ í† ê¸€ë¡œ ì‹œì‘) ===========
  async function sendMsg(){
    const f = document.getElementById('chat-field'); const txt = f.value.trim(); if(!txt) return;
    // 1) í´ë¼ì´ì–¸íŠ¸ì—ì„œ user ë©”ì‹œì§€ DBì— ë„£ê¸° (optional - anon í‚¤ë¡œ ì§ì ‘ ì‚½ì…í•˜ë ¤ë©´ RLS ì •ì±… í•„ìš”)
    try {
      await supabaseClient.from('chat_messages').insert([{ tag, sender:'user', content: txt }]);
    } catch(e){
      console.warn('user insert failed', e);
    }
    f.value = '';

    // 2) ì„œë²„ì— ì§ˆë¬¸ ìš”ì²­ -> ì„œë²„ê°€ bot ë©”ì‹œì§€ ì‚½ì…(í´ë¼ì´ì–¸íŠ¸ëŠ” êµ¬ë…ìœ¼ë¡œ ë°›ìŒ)
    try {
      await fetch('/api/chat', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ message: txt, inventory: JSON.stringify(activeItems), tag })
      });
    } catch(e){
      console.error('chat send failed', e);
      addMsg('bot', 'ì—°ê²° ì‹¤íŒ¨');
    }
  }

  function addMsg(type, text){
    const box = document.getElementById('chat-messages');
    const el = document.createElement('div'); el.className = 'msg ' + (type==='bot' ? 'bot' : 'user'); el.innerText = text;
    box.appendChild(el); box.scrollTop = box.scrollHeight;
  }

  async function setupChatSubscription(){
    if (typeof supabaseClient.channel !== 'function') {
      // fallback: poll every 2s (ìµœì•…ì˜ ê²½ìš°)
      console.warn('Realtime ì±„ë„ í•¨ìˆ˜ ë¯¸ì§€ì› - í´ë§ ëª¨ë“œ');
      return;
    }
    supabaseClient.channel('public:chat_messages')
      .on('postgres_changes', { event:'INSERT', schema:'public', table:'chat_messages', filter:`tag=eq.${tag}` }, payload => {
        const m = payload.new; addMsg(m.sender === 'bot' ? 'bot' : 'user', m.content);
      }).subscribe();

    // ì´ˆê¸° ë¡œë“œ: ìµœê·¼ ë©”ì‹œì§€
    const { data } = await supabaseClient.from('chat_messages').select('*').eq('tag', tag).order('created_at', { ascending: true }).limit(200);
    if (data) data.forEach(d => addMsg(d.sender === 'bot' ? 'bot' : 'user', d.content));
  }

  function toggleChat(){
    const w = document.getElementById('chat-window');
    const showing = (w.style.display === 'flex');
    w.style.display = showing ? 'none' : 'flex';
    if (!chatSubscribed && !showing) {
      chatSubscribed = true;
      setupChatSubscription();
    }
  }
</script>
</body>
</html>
