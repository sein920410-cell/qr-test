<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>(ì£¼)í˜„ì„¸ì¸ - ì‹œìŠ¤í…œ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: -apple-system, sans-serif; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; background: #f8f9fa; }
        #status-bar { width: 100%; position: fixed; top: 0; padding: 12px; background: #007bff; color: white; text-align: center; font-weight: bold; display: none; z-index: 1000; }
        .card { width: 100%; max-width: 400px; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-top: 50px; }
        h2 { font-size: 20px; margin-bottom: 20px; color: #333; }
        .btn { width: 100%; padding: 15px; background: #4A90E2; color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; }
        #preview { width: 100%; border-radius: 10px; margin: 20px 0; display: none; }
        .list-container { width: 100%; text-align: left; margin-top: 20px; }
        ul { list-style: none; padding: 0; border-top: 1px solid #eee; }
        li { padding: 12px 0; border-bottom: 1px solid #eee; color: #555; }
    </style>
</head>
<body>

    <div id="status-bar"></div>

    <div class="card">
        <h2>ğŸ“¦ ì„œë ì•„ì´í…œ ë“±ë¡</h2>
        <input type="file" id="cam" accept="image/*" capture="environment" style="display: none;">
        <button class="btn" onclick="document.getElementById('cam').click()">ğŸ“· ì‚¬ì§„ ì°ê¸°</button>
        
        <img id="preview">
        
        <div class="list-container">
            <strong>ğŸ“‹ ë¶„ì„ ê²°ê³¼</strong>
            <ul id="item-list"></ul>
        </div>
    </div>

    <script>
        // 1. í”„ë¡œì íŠ¸ ì„¤ì • (ìŠ¤í¬ë¦°ìƒ· ì£¼ì†Œ ë°˜ì˜)
        const S_URL = 'https://tqhtggusphhcsygiitrv.supabase.co';
        const S_KEY = 'YOUR_SUPABASE_ANON_KEY'; // ì„¸ì¸ë‹˜ì˜ ANON KEYë¥¼ ì…ë ¥í•˜ì„¸ìš”
        const supabase = lib.supabase.createClient(S_URL, S_KEY);

        const cam = document.getElementById('cam');
        const bar = document.getElementById('status-bar');
        const list = document.getElementById('item-list');
        const prev = document.getElementById('preview');

        function msg(text, err = false) {
            bar.innerText = text;
            bar.style.display = 'block';
            bar.style.background = err ? '#ff4d4d' : '#007bff';
        }

        cam.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            prev.src = URL.createObjectURL(file);
            prev.style.display = 'block';

            try {
                // 2. ë¡œê·¸ì¸ ì„¸ì…˜ ê°•ì œ í™•ì¸ (ìŠ¤í¬ë¦°ìƒ·ì˜ 'authenticated' ì •ì±… ë•Œë¬¸)
                const { data: { session } } = await supabase.auth.getSession();
                if (!session) {
                    msg("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. login.htmlë¡œ ì´ë™í•˜ì„¸ìš”.", true);
                    return;
                }
                const uid = session.user.id;

                msg("ì‚¬ì§„ ì••ì¶• ë° ìµœì í™” ì¤‘...");
                const blob = await resizeImg(file);

                msg("ì„œë ì €ì¥ì†Œ ì—…ë¡œë“œ ì¤‘...");
                // 3. ìŠ¤í¬ë¦°ìƒ· ì •ì±…ì— ë§ëŠ” ê²½ë¡œ: USER_UPLOADS ë²„í‚· / ìœ ì €ID í´ë”
                const path = `${uid}/${Date.now()}.jpg`;
                const { error: upErr } = await supabase.storage
                    .from('USER_UPLOADS') 
                    .upload(path, blob, { contentType: 'image/jpeg' });

                if (upErr) throw upErr;

                // 4. ê³µê°œ URL ìƒì„±
                const { data: { publicUrl } } = supabase.storage.from('USER_UPLOADS').getPublicUrl(path);

                msg("ë¹„ì„œ 'ê²°'ì´ ë¬¼ê±´ íŒŒì•… ì¤‘...");
                // 5. Vercel API í˜¸ì¶œ
                const res = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ imageUrl: publicUrl })
                });

                const data = await res.json();
                if (data.items) {
                    showItems(data.items);
                    msg("ë“±ë¡ ì™„ë£Œ!");
                } else {
                    throw new Error(data.error || "ë¶„ì„ ì‹¤íŒ¨");
                }

            } catch (err) {
                console.error(err);
                msg(`ì˜¤ë¥˜: ${err.message}`, true);
            }
        });

        // Vercel 10ì´ˆ ì œí•œ ëŒíŒŒìš© ì••ì¶• (ê°€ë¡œ 700px)
        function resizeImg(file) {
            return new Promise((res) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const w = 700;
                        const h = img.height * (w / img.width);
                        canvas.width = w; canvas.height = h;
                        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                        canvas.toBlob((b) => res(b), 'image/jpeg', 0.8);
                    };
                };
            });
        }

        function showItems(str) {
            list.innerHTML = str.split(',').map(i => `<li>${i.trim()}</li>`).join('');
        }
    </script>
</body>
</html>
