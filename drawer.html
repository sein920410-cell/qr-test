<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Í≥µÍ∞Ñ:Í≤∞ - Í¥ÄÎ¶¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root { --primary:#007bff; --bg:#f8fafc; --card:#fff; }
    body{font-family:-apple-system, sans-serif;background:var(--bg);margin:0;padding:12px;padding-bottom:100px;}
    .main-card{background:var(--card);border-radius:20px;padding:20px;box-shadow:0 8px 20px rgba(0,0,0,0.06);}
    .upload-tools{display:flex;gap:8px;margin-bottom:12px;}
    .btn-upload{flex:1;padding:12px;border-radius:12px;border:1px solid #e6eefc;cursor:pointer;}
    .btn-upload.primary{background:var(--primary);color:#fff;border:none;}
    .search-input{width:100%;padding:12px;border-radius:10px;border:2px solid var(--primary);margin-bottom:12px;}
    .cat-group{margin-bottom:10px;border-radius:12px;background:#fff;padding:10px;border:1px solid #eef6ff;}
    .item-row{background:#f0f7ff;padding:12px;border-radius:10px;margin-bottom:8px;position:relative;}
    .qty-badge{position:absolute;right:12px;top:12px;background:var(--primary);color:#fff;padding:4px 8px;border-radius:8px;}
    .chat-btn{position:fixed;bottom:20px;right:20px;background:#000;color:#fff;padding:14px 18px;border-radius:50px;cursor:pointer;}
    .chat-window{display:none;position:fixed;bottom:85px;right:20px;width:320px;height:420px;background:#fff;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,0.2);overflow:hidden;z-index:1001;flex-direction:column;}
    .chat-messages{flex:1;padding:12px;overflow:auto;background:#f8fafc;display:flex;flex-direction:column;gap:8px;}
    .msg{padding:10px;border-radius:12px;max-width:80%;}
    .msg.bot{background:#e2e8f0;align-self:flex-start;}
    .msg.user{background:var(--primary);color:#fff;align-self:flex-end;}
    .chat-input-area{padding:10px;border-top:1px solid #eee;display:flex;gap:8px;}
    .chat-input{flex:1;padding:10px;border-radius:10px;border:1px solid #ddd;}
  </style>
</head>
<body>
  <div class="main-card">
    <div style="font-weight:800;margin-bottom:12px;" id="disp-id">ÏÑúÎûç Ï†ïÎ≥¥ ÌôïÏù∏ Ï§ë...</div>
    <div class="upload-tools">
      <button class="btn-upload primary" onclick="document.getElementById('camera-input').click()">üì∏ Ï¶âÏãú Ï¥¨ÏòÅ</button>
      <button class="btn-upload" onclick="document.getElementById('album-input').click()">üñº Ïï®Î≤î ÏÑ†ÌÉù</button>
    </div>

    <input type="file" id="camera-input" accept="image/*" capture="environment" style="display:none" onchange="handleFile(this)">
    <input type="file" id="album-input" accept="image/*" style="display:none" onchange="handleFile(this)">
    <input type="text" id="find-box" class="search-input" placeholder="Í≤ÄÏÉâ ÌõÑ ÏóîÌÑ∞Î•º ÎàÑÎ•¥ÏÑ∏Ïöî.">
    <div id="list-container"></div>
  </div>

  <button class="chat-btn" onclick="toggleChat()">‚ú® Í≤∞ÏóêÍ≤å Î¨ªÍ∏∞</button>

  <div id="chat-window" class="chat-window" style="display:flex;flex-direction:column;">
    <div style="background:#000;color:#fff;padding:12px;display:flex;justify-content:space-between;align-items:center;">
      <span>ÎπÑÏÑú 'Í≤∞'</span><span style="cursor:pointer" onclick="toggleChat()">‚úï</span>
    </div>
    <div id="chat-messages" class="chat-messages"></div>
    <div class="chat-input-area">
      <input type="text" id="chat-field" class="chat-input" placeholder="Î©îÏãúÏßÄ ÏûÖÎ†•..." onkeydown="if(event.key==='Enter') sendMsg()">
      <button style="background:var(--primary);color:#fff;border:none;padding:8px 12px;border-radius:8px;" onclick="sendMsg()">Ï†ÑÏÜ°</button>
    </div>
  </div>

<script>
  // === ÏÑ§Ï†ïÍ∞í (ÌîÑÎ°úÎçïÏÖò Ï†ÑÏóê ÌôòÍ≤ΩÎ≥ÄÏàòÎ°ú ÎåÄÏ≤¥ Í∂åÏû•) ===
  const SUPABASE_URL = 'https://tqhtggusphhcsygiitrv.supabase.co'; // Î≥ÄÍ≤ΩÌïòÏßÄ ÎßàÏÑ∏Ïöî (ÏΩòÏÜî Í∞í)
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdX...'; // Í∏∞Ï°¥ ÏùµÎ™ÖÌÇ§(ÏûÑÏãú)
  const BUCKET = 'user_uploads'; // **Ï§ëÏöî**: Supabase ÏΩòÏÜîÏóê ÎßåÎì† Î≤ÑÌÇ∑Î™ÖÍ≥º ÎèôÏùºÌï¥Ïïº Ìï®

  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  const tag = (new URLSearchParams(window.location.search).get('tag') || 'DRAWER001').toUpperCase();
  let activeItems = [];

  // Ï¥àÍ∏∞ Îç∞Ïù¥ÌÑ∞ Î°úÎìú
  window.onload = async () => {
    document.getElementById('disp-id').innerText = (tag === 'DRAWER002') ? 'ÏÑúÎûç 2Î≤à' : 'ÏÑúÎûç 1Î≤à';
    const s = localStorage.getItem('gonggan_gyeol_'+tag);
    activeItems = s ? JSON.parse(s) : [{cat:'Í∏∞ÌÉÄ', n:'ÏÉòÌîåÎ¨ºÌíà', q:1}];
    render();
    setupChatSubscription();
  };

  function render() {
    const container = document.getElementById('list-container');
    container.innerHTML = '';
    const cats = [...new Set(activeItems.map(i=>i.cat))];
    cats.forEach(c=>{
      const list = activeItems.filter(i=>i.cat===c);
      const div = document.createElement('div'); div.className='cat-group';
      div.innerHTML = `<div style="font-weight:800;margin-bottom:8px;">${c} (${list.length})</div>
        <div>${list.map(it=>`<div class="item-row"><div style="font-weight:800">${it.n}</div><div class="qty-badge">${it.q} EA</div>
        <div style="font-size:12px;margin-top:6px;"><button onclick="editItem(${activeItems.indexOf(it)})">Ïù¥Î¶Ñ ÏàòÏ†ï</button> | <button onclick="deleteItem(${activeItems.indexOf(it)})">ÏÇ≠Ï†ú</button></div></div>`).join('')}</div>`;
      container.appendChild(div);
    });
  }

  function saveAndRender(){ localStorage.setItem('gonggan_gyeol_'+tag, JSON.stringify(activeItems)); render(); }

  // ÏàòÏ†ï/ÏÇ≠Ï†ú
  function editItem(idx){
    const item = activeItems[idx];
    const newName = prompt('ÏÉà Ïù¥Î¶Ñ:', item.n); if (!newName) return;
    const newCat = prompt('Ïπ¥ÌÖåÍ≥†Î¶¨:', item.cat) || item.cat;
    item.n = newName; item.cat = newCat;
    saveAndRender();
  }
  function deleteItem(idx){ if(confirm('ÏÇ≠Ï†úÌï†ÍπåÏöî?')){ activeItems.splice(idx,1); saveAndRender(); } }

  // ÌååÏùº ÏóÖÎ°úÎìú Ìï∏Îì§Îü¨
  async function handleFile(input){
    const file = input.files[0]; if(!file) return;
    const status = document.getElementById('disp-id');
    status.innerText = 'Î∂ÑÏÑù Ï§ë...'; status.style.opacity = 0.7;
    try {
      const fName = `${Date.now()}_${file.name}`;
      const { data: upData, error: upErr } = await supabaseClient.storage.from(BUCKET).upload(fName, file, { upsert: true });
      if (upErr) throw upErr;

      // public URL ÏãúÎèÑ
      const { data: p } = supabaseClient.storage.from(BUCKET).getPublicUrl(fName);
      let publicUrl = p?.publicUrl || '';

      // publicUrl Ïú†Ìö®ÌïòÏßÄ ÏïäÏúºÎ©¥ signed url ÏÉùÏÑ±
      if (!publicUrl || publicUrl.includes('null')) {
        const { data: sdata, error: signErr } = await supabaseClient.storage.from(BUCKET).createSignedUrl(fName, 60);
        if (signErr) throw signErr;
        publicUrl = sdata?.signedUrl;
      }

      // Î∂ÑÏÑù API Ìò∏Ï∂ú
      const res = await fetch('/api/analyze', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ imageUrl: publicUrl })
      });
      const json = await res.json();
      if (json.items && Array.isArray(json.items)) {
        json.items.forEach(n => activeItems.push({ cat: 'Ïã†Í∑ú Ïù∏Ïãù', n: n, q: 1 }));
        saveAndRender();
        status.innerText = 'Î∂ÑÏÑù ÏôÑÎ£å';
      } else {
        throw new Error(json.error || 'Ïù∏Ïãù Í≤∞Í≥º ÏóÜÏùå');
      }
    } catch (e) {
      status.innerText = 'ÏóêÎü¨: ' + (e.message || e);
      status.style.color = 'red';
      console.error(e);
    } finally {
      setTimeout(()=>{ document.getElementById('disp-id').innerText = (tag==='DRAWER002')?'ÏÑúÎûç 2Î≤à':'ÏÑúÎûç 1Î≤à'; }, 1500);
    }
  }

  // Ï±ÑÌåÖ: ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ÏóêÏÑú user Î©îÏãúÏßÄÎ•º chat_messages ÌÖåÏù¥Î∏îÏóê ÏÇΩÏûÖÌïòÍ≥†, /api/chat Ìò∏Ï∂úÎ°ú bot ÏùëÎãµÏùÑ ÏÑúÎ≤ÑÍ∞Ä ÏÇΩÏûÖÌïòÍ≤å Ìï®.
  async function sendMsg(){
    const f = document.getElementById('chat-field'); const txt = f.value.trim(); if(!txt) return;
    // 1) ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ÏóêÏÑú user Î©îÏãúÏßÄ DBÏóê ÎÑ£Í∏∞
    await supabaseClient.from('chat_messages').insert([{ tag, sender:'user', content: txt }]);
    f.value = '';
    // 2) ÏÑúÎ≤ÑÏóê ÏöîÏ≤≠ -> ÏÑúÎ≤ÑÍ∞Ä bot Î©îÏãúÏßÄ DBÏóê ÎÑ£Ïùå (ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏Îäî Íµ¨ÎèÖÏúºÎ°ú Î∞õÏùå)
    try {
      await fetch('/api/chat', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ message: txt, inventory: JSON.stringify(activeItems), tag })
      });
    } catch(e){
      console.error('chat send error', e);
    }
  }

  function toggleChat(){ const w = document.getElementById('chat-window'); w.style.display = (w.style.display==='flex')?'none':'flex'; }

  // Ïã§ÏãúÍ∞Ñ Íµ¨ÎèÖ ÏÑ§Ï†ï
  function setupChatSubscription(){
    // ÏÑúÎ≤ÑÏóêÏÑú Postgres change feedÎ•º ÏÇ¨Ïö©ÌïòÏó¨ chat_messages INSERTÎ•º Î∞õÏùå
    const channel = supabaseClient.channel('public:chat_messages')
      .on('postgres_changes', { event:'INSERT', schema:'public', table:'chat_messages', filter:`tag=eq.${tag}` }, payload => {
        const m = payload.new;
        addMsg(m.sender === 'bot' ? 'bot' : 'user', m.content);
      }).subscribe();

    // Ï¥àÍ∏∞ Î°úÎìú: ÏµúÍ∑º 50Í∞ú
    (async ()=>{
      const { data, error } = await supabaseClient.from('chat_messages').select('*').eq('tag', tag).order('created_at', { ascending: true }).limit(200);
      if (data) data.forEach(d => addMsg(d.sender === 'bot' ? 'bot' : 'user', d.content));
    })();
  }

  function addMsg(type, text){
    const box = document.getElementById('chat-messages');
    const el = document.createElement('div'); el.className = 'msg ' + (type==='bot' ? 'bot' : 'user'); el.innerText = text;
    box.appendChild(el);
    box.scrollTop = box.scrollHeight;
  }
</script>
</body>
</html>
