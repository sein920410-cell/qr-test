<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>(ì£¼)í˜„ì„¸ì¸ - ì„œë ê´€ë¦¬</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <style>
        /* ì„¸ì¸ ë‹˜ì˜ ìš”ì²­ëŒ€ë¡œ UIëŠ” ìµœëŒ€í•œ ì‹¬í”Œí•˜ê²Œ ìœ ì§€í•©ë‹ˆë‹¤. */
        #status-bar {
            position: fixed;
            top: 0; left: 0; width: 100%;
            padding: 10px;
            background: #333; color: #fff;
            text-align: center;
            display: none; /* í•„ìš”í•  ë•Œë§Œ ë…¸ì¶œ */
            z-index: 1000;
        }
        .container { padding: 20px; margin-top: 40px; }
        .upload-btn { padding: 15px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        #preview { width: 100%; max-width: 300px; margin-top: 10px; display: none; }
    </style>
</head>
<body>

    <div id="status-bar">ì¤€ë¹„ ì¤‘...</div>

    <div class="container">
        <h2>ì„œë ì•„ì´í…œ ë“±ë¡</h2>
        <input type="file" id="file-input" accept="image/*" capture="environment" style="display: none;">
        <button class="upload-btn" onclick="document.getElementById('file-input').click()">ğŸ“· ì‚¬ì§„ ì°ì–´ì„œ ë“±ë¡í•˜ê¸°</button>
        
        <img id="preview" alt="ë¯¸ë¦¬ë³´ê¸°">
        
        <div id="result-list" style="margin-top: 20px;">
            <h3>ë¶„ì„ëœ ë¬¼ê±´ ëª©ë¡:</h3>
            <ul id="items-ul"></ul>
        </div>
    </div>

    <script>
        // 1. Supabase ì´ˆê¸°í™” (ì„¸ì¸ ë‹˜ì˜ í”„ë¡œì íŠ¸ URLê³¼ Anon Keyë¥¼ ì…ë ¥í•˜ì„¸ìš”)
        const SUPABASE_URL = 'https://tqhtggusphhcsygiitrv.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRxaHRnZ3VzcGhoY3N5Z2lpdHJ2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEwNDMxMTMsImV4cCI6MjA4NjYxOTExM30.HXA2GbucJPkt3LFl9_JpLiwUQvI95QNEDeQWzQ9i-pc';
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const fileInput = document.getElementById('file-input');
        const statusBar = document.getElementById('status-bar');
        const itemsUl = document.getElementById('items-ul');
        const preview = document.getElementById('preview');

        // ìƒíƒœ ì•ˆë‚´ ë©”ì‹œì§€ í•¨ìˆ˜ (alert() ëŒ€ì‹  ì‚¬ìš©)
        function showStatus(msg, isError = false) {
            statusBar.innerText = msg;
            statusBar.style.display = 'block';
            statusBar.style.background = isError ? '#ff4d4d' : '#333';
        }

        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // ë¯¸ë¦¬ë³´ê¸° ë…¸ì¶œ
            preview.src = URL.createObjectURL(file);
            preview.style.display = 'block';

            try {
                // 2. ë¡œê·¸ì¸ í™•ì¸ (RLS í†µê³¼ë¥¼ ìœ„í•´ í•„ìˆ˜)
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    showStatus("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ ì£¼ì„¸ìš”.", true);
                    return;
                }

                showStatus("ì‚¬ì§„ì„ ìµœì í™”í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...");
                
                // 3. ì´ë¯¸ì§€ ì••ì¶• (Vercel 4.5MB ì œí•œ ë° 10ì´ˆ íƒ€ì„ì•„ì›ƒ ë°©ì§€)
                const compressedBlob = await compressImage(file);

                showStatus("ì„œëì— ì‚¬ì§„ì„ ì €ì¥í•˜ëŠ” ì¤‘...");
                
                // 4. Supabase Storage ì—…ë¡œë“œ (USER_UPLOADS ë²„í‚·)
                const filePath = `${user.id}/${Date.now()}.jpg`; // ì‚¬ìš©ì ì „ìš© ê²½ë¡œ ì„¤ì •
                const { data: uploadData, error: uploadError } = await supabase.storage
                    .from('USER_UPLOADS') 
                    .upload(filePath, compressedBlob, {
                        contentType: 'image/jpeg',
                        upsert: true
                    });

                if (uploadError) throw uploadError;

                // 5. ê³µê°œ URL ê°€ì ¸ì˜¤ê¸°
                const { data: { publicUrl } } = supabase.storage.from('USER_UPLOADS').getPublicUrl(filePath);

                showStatus("ì§€ëŠ¥í˜• ë¹„ì„œ 'ê²°'ì´ ë¬¼ê±´ì„ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...");

                // 6. Gemini API ë¶„ì„ ìš”ì²­ (api/analyze.js í˜¸ì¶œ)
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ imageUrl: publicUrl })
                });

                const analysis = await response.json();
                
                if (analysis.items) {
                    displayItems(analysis.items);
                    showStatus("ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
                } else {
                    throw new Error(analysis.error || "ë¶„ì„ ì‹¤íŒ¨");
                }

            } catch (err) {
                console.error(err);
                showStatus(`ì—ëŸ¬ ë°œìƒ: ${err.message}`, true);
            }
        });

        // ì´ë¯¸ì§€ ì••ì¶• ë¡œì§ (ê°€ë¡œ 700px ê¸°ì¤€)
        function compressImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 700;
                        const scaleSize = MAX_WIDTH / img.width;
                        canvas.width = MAX_WIDTH;
                        canvas.height = img.height * scaleSize;

                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        
                        canvas.toBlob((blob) => {
                            resolve(blob);
                        }, 'image/jpeg', 0.7); // í™”ì§ˆ 70% ìˆ˜ì¤€ìœ¼ë¡œ ì••ì¶•
                    };
                };
            });
        }

        // ê²°ê³¼ ëª©ë¡ ì¶œë ¥
        function displayItems(itemsString) {
            itemsUl.innerHTML = '';
            const items = itemsString.split(',');
            items.forEach(item => {
                const li = document.createElement('li');
                li.innerText = item.trim();
                itemsUl.appendChild(li);
            });
        }
    </script>
</body>
</html>
