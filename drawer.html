<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>(ì£¼)í˜„ì„¸ì¸ ì›¹ ê¸°ë°˜ ì‹œìŠ¤í…œ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: -apple-system, sans-serif; margin: 0; padding: 0; background: #F5F5F7; color: #1D1D1F; }
        #status-bar { position: fixed; top: 0; width: 100%; padding: 12px; background: #007AFF; color: white; text-align: center; font-weight: 600; display: none; z-index: 9999; }
        .container { padding: 20px; max-width: 500px; margin: 40px auto; }
        .upload-card { background: white; border-radius: 20px; padding: 24px; box-shadow: 0 8px 30px rgba(0,0,0,0.08); text-align: center; }
        .btn-main { background: #007AFF; color: white; border: none; border-radius: 12px; padding: 18px; width: 100%; font-size: 17px; font-weight: 600; cursor: pointer; transition: 0.2s; }
        #preview { width: 100%; border-radius: 12px; margin-top: 20px; display: none; }
        .result-area { margin-top: 30px; text-align: left; }
        .category-tag { background: #E8E8ED; padding: 4px 10px; border-radius: 6px; font-size: 13px; color: #86868B; }
        ul { list-style: none; padding: 0; }
        li { padding: 15px 0; border-bottom: 1px solid #F2F2F7; font-size: 16px; display: flex; justify-content: space-between; }
    </style>
</head>
<body>

<div id="status-bar">ì¤€ë¹„ ì¤‘...</div>

<div class="container">
    <div class="upload-card">
        <h2 style="margin-top:0;">ğŸ“¦ ì„œë ì•„ì´í…œ ë“±ë¡</h2>
        <input type="file" id="camera-input" accept="image/*" capture="environment" style="display: none;">
        <button class="btn-main" onclick="document.getElementById('camera-input').click()">ğŸ“· ì‚¬ì§„ ì°ê¸°</button>
        <img id="preview" alt="ì„ íƒí•œ ì´ë¯¸ì§€">
    </div>

    <div class="result-area">
        <h3 style="font-size: 20px;">ğŸ“‹ ë¶„ì„ëœ ë¬¼ê±´ ëª©ë¡</h3>
        <ul id="item-list">
            <li style="color: #86868B;">ì‚¬ì§„ì„ ì°ìœ¼ë©´ 'ê²°'ì´ ë¶„ì„ì„ ì‹œì‘í•©ë‹ˆë‹¤.</li>
        </ul>
    </div>
</div>

<script>
    // 1. ì´ˆê¸°í™” (ì„¸ì¸ ë‹˜ í”„ë¡œì íŠ¸ ì •ë³´)
    const SB_URL = 'https://tqhtggusphhcsygiitrv.supabase.co';
    const SB_KEY = 'YOUR_ANON_KEY'; // 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRxaHRnZ3VzcGhoY3N5Z2lpdHJ2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEwNDMxMTMsImV4cCI6MjA4NjYxOTExM30.HXA2GbucJPkt3LFl9_JpLiwUQvI95QNEDeQWzQ9i-pc'ì—¬ê¸°ì— ANON KEYë¥¼ ê¼­ ë„£ì–´ì£¼ì„¸ìš”.
    const supabase = lib.supabase.createClient(SB_URL, SB_KEY);

    const cameraInput = document.getElementById('camera-input');
    const statusBar = document.getElementById('status-bar');
    const itemList = document.getElementById('item-list');
    const preview = document.getElementById('preview');

    function updateStatus(text, isError = false) {
        statusBar.innerText = text;
        statusBar.style.display = 'block';
        statusBar.style.background = isError ? '#FF3B30' : '#007AFF';
    }

    cameraInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        preview.src = URL.createObjectURL(file);
        preview.style.display = 'block';

        try {
            // 2. ë¡œê·¸ì¸ ì„¸ì…˜ í™•ì¸ (ì—†ìœ¼ë©´ ì—…ë¡œë“œ ë¶ˆê°€)
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                updateStatus("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. login.htmlë¡œ ì´ë™í•˜ì„¸ìš”.", true);
                return;
            }
            const uid = session.user.id;

            updateStatus("ì´ë¯¸ì§€ ìµœì í™” ì¤‘...");
            const blob = await resizeImage(file);

            updateStatus("ì„œë(USER_UPLOADS)ì— ì €ì¥ ì¤‘...");
            // 3. íŒŒì¼ ê²½ë¡œ: ìœ ì €ID/íŒŒì¼ëª… (RLS ì •ì±… ì¤€ìˆ˜)
            const fileName = `${Date.now()}.jpg`;
            const filePath = `${uid}/${fileName}`;

            const { error: upError } = await supabase.storage
                .from('USER_UPLOADS')
                .upload(filePath, blob, { contentType: 'image/jpeg', upsert: true });

            if (upError) throw upError;

            // 4. ê³µê°œ URL íšë“ ë° AI ë¶„ì„
            const { data: { publicUrl } } = supabase.storage.from('USER_UPLOADS').getPublicUrl(filePath);

            updateStatus("ë¹„ì„œ 'ê²°'ì´ ë¬¼ê±´ì„ ë¶„ë¥˜í•˜ê³  ìˆìŠµë‹ˆë‹¤...");
            const response = await fetch('/api/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ imageUrl: publicUrl })
            });

            const data = await response.json();
            if (data.items) {
                renderItems(data.items);
                updateStatus("ë¶„ì„ ë° ë“±ë¡ ì™„ë£Œ!");
            } else {
                throw new Error(data.error || "ë¶„ì„ ì‹¤íŒ¨");
            }

        } catch (err) {
            console.error(err);
            updateStatus(`ì˜¤ë¥˜: ${err.message}`, true);
        }
    });

    // Vercel 10ì´ˆ íƒ€ì„ì•„ì›ƒ ë°©ì§€ ë¡œì§ (ê°€ë¡œ 700px ì••ì¶•)
    function resizeImage(file) {
        return new Promise((res) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const width = 700;
                    const scale = width / img.width;
                    canvas.width = width;
                    canvas.height = img.height * scale;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    canvas.toBlob((b) => res(b), 'image/jpeg', 0.8);
                };
            };
        });
    }

    function renderItems(itemsStr) {
        itemList.innerHTML = '';
        itemsStr.split(',').forEach(item => {
            const li = document.createElement('li');
            li.innerHTML = `<span>${item.trim()}</span> <span class="category-tag">ìë™ë¶„ë¥˜</span>`;
            itemList.appendChild(li);
        });
    }
</script>
</body>
</html>
