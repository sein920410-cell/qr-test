<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ê³µê°„:ê²° - ì¸ë²¤í† ë¦¬ ë¦¬í¬íŠ¸</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* ì„¸ì¸ ë‹˜ì˜ ì˜¤ë¦¬ì§€ë„ UI (image_234c7d.png) ë³µêµ¬ */
        body { font-family: -apple-system, sans-serif; margin: 0; padding: 0; background: #F8F9FB; color: #333; }
        #status-bar { position: fixed; top: 0; width: 100%; padding: 10px; background: #000; color: #FFF; text-align: center; font-size: 13px; display: none; z-index: 10000; }
        .container { padding: 15px; max-width: 500px; margin: 0 auto; }
        .search-box { background: white; border: 1.5px solid #007AFF; border-radius: 8px; padding: 12px; margin-bottom: 20px; color: #999; }
        .upload-card { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); text-align: center; margin-bottom: 20px; }
        .btn-upload { background: #4A90E2; color: white; border: none; border-radius: 8px; padding: 14px; width: 100%; font-size: 15px; font-weight: bold; cursor: pointer; }
        .inventory-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; font-weight: bold; }
        .category-group { background: white; border-radius: 12px; margin-bottom: 15px; border: 1px solid #EEE; }
        .category-header { padding: 15px; background: #FDFDFD; border-bottom: 1px solid #F5F5F5; display: flex; justify-content: space-between; font-weight: bold; font-size: 14px; }
        .item-row { padding: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #F9F9F9; }
        .btn-qty { border: 1px solid #DDD; background: #FFF; border-radius: 4px; width: 24px; height: 24px; color: #007AFF; cursor: pointer; }
        .ask-btn { position: fixed; bottom: 20px; right: 20px; background: #000; color: white; padding: 12px 20px; border-radius: 30px; font-size: 14px; font-weight: bold; }
    </style>
</head>
<body>

<div id="status-bar"></div>

<div class="container">
    <div class="search-box">ë¬´ì—‡ì„ ì°¾ìœ¼ì‹œë‚˜ìš”?</div>

    <div class="upload-card">
        <h2 style="font-size: 20px; margin-bottom: 15px;">ì„œë ì•„ì´í…œ ë“±ë¡</h2>
        <input type="file" id="file-selector" accept="image/*" style="display: none;">
        <button class="btn-upload" onclick="document.getElementById('file-selector').click()">ğŸ“· ì‚¬ì§„ ì°ì–´ì„œ ë“±ë¡í•˜ê¸°</button>
    </div>

    <div class="inventory-header">
        <span>ğŸ“¦ ë³´ê´€ ë¬¼í’ˆ ì „ì²´ ëª©ë¡</span>
        <span style="font-size: 12px; color: #888;">ì „ì²´ ì ‘ê¸° â–²</span>
    </div>

    <div id="category-container">
        </div>
</div>

<div class="ask-btn">âœ¨ ê²°ì—ê²Œ ë¬»ê¸°</div>

<script>
    // 1. Supabase ì„¤ì • ìœ ì§€
    const S_URL = 'https://tqhtggusphhcsygiitrv.supabase.co';
    const S_KEY = 'YOUR_ANON_KEY'; // ì„¸ì¸ë‹˜ì˜ ANON KEY
    const supabase = lib.supabase.createClient(S_URL, S_KEY);

    const fileSelector = document.getElementById('file-selector');
    const statusBar = document.getElementById('status-bar');
    const categoryContainer = document.getElementById('category-container');

    function showMsg(text, isErr = false) {
        statusBar.innerText = text;
        statusBar.style.display = 'block';
        statusBar.style.background = isErr ? '#FF3B30' : '#000';
    }

    fileSelector.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        try {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                showMsg("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.", true);
                return;
            }
            const uid = session.user.id;

            showMsg("ì´ë¯¸ì§€ ìµœì í™” ì¤‘...");
            const blob = await compress(file);

            showMsg("ì„œë ì €ì¥ì†Œ(USER_UPLOADS)ì— ì €ì¥ ì¤‘...");
            const path = `${uid}/${Date.now()}.jpg`;
            const { error: upError } = await supabase.storage
                .from('USER_UPLOADS')
                .upload(path, blob, { contentType: 'image/jpeg' });

            if (upError) throw upError;

            const { data: { publicUrl } } = supabase.storage.from('USER_UPLOADS').getPublicUrl(path);

            showMsg("ë¹„ì„œ 'ê²°'ì´ ë¦¬í¬íŠ¸ë¥¼ ì‘ì„± ì¤‘ì…ë‹ˆë‹¤...");
            const res = await fetch('/api/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ imageUrl: publicUrl })
            });

            const data = await res.json();
            if (data.items) {
                renderList(data.items);
                showMsg("ì¸ë²¤í† ë¦¬ ì—…ë°ì´íŠ¸ ì™„ë£Œ!");
            }
        } catch (err) {
            showMsg(`ì˜¤ë¥˜: ${err.message}`, true);
        }
    });

    // 10ì´ˆ íƒ€ì„ì•„ì›ƒ ë°©ì§€ìš© ì••ì¶• ë¡œì§
    function compress(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const width = 700;
                    canvas.width = width;
                    canvas.height = img.height * (width / img.width);
                    canvas.getContext('2d').drawImage(img, 0, 0, width, canvas.height);
                    canvas.toBlob((b) => resolve(b), 'image/jpeg', 0.8);
                };
            };
        });
    }

    function renderList(itemsStr) {
        categoryContainer.innerHTML = '';
        const items = itemsStr.split(',');
        const group = document.createElement('div');
        group.className = 'category-group';
        group.innerHTML = `<div class="category-header">ì‹ ê·œ ë¶„ì„ í•­ëª© (${items.length}) <span>âŒµ</span></div>`;
        
        items.forEach(item => {
            const row = document.createElement('div');
            row.className = 'item-row';
            row.innerHTML = `
                <div class="item-name">${item.trim()}</div>
                <div class="item-ctrl">
                    <button class="btn-qty">-</button> 1 <span style="font-size: 11px; color: #999;">EA</span> <button class="btn-qty">+</button>
                </div>`;
            group.appendChild(row);
        });
        categoryContainer.appendChild(group);
    }
</script>
</body>
</html>
