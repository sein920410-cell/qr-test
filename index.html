<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>ì°¾ì•˜ë‹¤! - AI ë¬¼í’ˆ ê´€ë¦¬ ì†”ë£¨ì…˜</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: 'Pretendard', sans-serif; padding: 20px; background: #f8f9fa; color: #333; line-height: 1.6; }
        .card { background: #fff; padding: 20px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: none; margin-bottom: 20px; }
        #auth-section { background: #fff; padding: 30px; border-radius: 15px; border: 2px solid #333; text-align: center; }
        input, textarea { width: 100%; margin: 10px 0; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        button { width: 100%; padding: 14px; background: #333; color: #fff; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        button:hover { background: #555; }
        .item-card { padding: 15px; border-bottom: 1px solid #eee; display: flex; align-items: center; background: #fff; border-radius: 8px; margin-bottom: 5px; }
        #search-input { border: 2px solid #333; margin-bottom: 20px; background: #fff; }
        .upload-area { background: #f0f4f8; padding: 15px; border-radius: 10px; border: 2px dashed #007bff; margin: 20px 0; }
        .status-msg { font-size: 13px; color: #007bff; margin-top: 5px; font-weight: bold; }
    </style>
</head>
<body>

    <div id="auth-section">
        <h2>ğŸ”’ ë³´ì•ˆ ì ‘ì†</h2>
        <p>ë“±ë¡ëœ ê´€ë¦¬ì ì´ë©”ì¼ë¡œ ì¸ì¦í•´ì•¼<br>ë¬¼í’ˆì„ ì°¾ê±°ë‚˜ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        <input type="email" id="email-input" placeholder="ì´ë©”ì¼ ì£¼ì†Œ ì…ë ¥">
        <button id="login-btn">ì¸ì¦ ë©”ì¼ ë°›ê¸°</button>
    </div>

    <div id="main-card" class="card">
        <h2 id="drawer-name">ë°ì´í„° ë¡œë”© ì¤‘...</h2>
        
        <input type="text" id="search-input" placeholder="ğŸ” ì–´ë–¤ ë¬¼ê±´ì„ ì°¾ìœ¼ì‹œë‚˜ìš”?">
        <div id="display-container"></div>

        <div class="upload-area">
            <p style="margin-top:0;">ğŸ¥ <strong>ì„œë ì•ˆ ì´¬ì˜í•˜ê¸°</strong></p>
            <input type="file" id="video-input" accept="video/*" capture="environment">
            <button id="upload-btn" style="background:#007bff; margin-top:10px;">ì˜ìƒ ì „ì†¡í•˜ì—¬ ëª©ë¡ ë§Œë“¤ê¸°</button>
            <p id="upload-status" class="status-msg"></p>
        </div>

        <div style="margin-top:25px; border-top:2px dashed #eee; padding-top:15px;">
            <p>ğŸ› ï¸ <strong>ê´€ë¦¬ì ìˆ˜ì •</strong></p>
            <input type="text" id="new-name" placeholder="ì„œë ì´ë¦„ ìˆ˜ì •">
            <textarea id="edit-items" rows="5" placeholder="ë¬¼í’ˆ ëª©ë¡ (ì‰¼í‘œë¡œ êµ¬ë¶„)"></textarea>
            <button id="save-btn" style="background:#2e7d32;">ëª©ë¡ ì €ì¥í•˜ê¸°</button>
        </div>
    </div>

    <script type="module">
        import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm"
        
        // Supabase ì„¤ì • [cite: 2026-02-15]
        const supabase = createClient("https://tqhtggusphhcsygiitrv.supabase.co", "sb_publishable_D9nhmN5ZlyApSrHHasyQ3w_O7Kdmssq")
        
        // URLì—ì„œ íƒœê·¸ ID ì¶”ì¶œ (ì˜ˆ: ?tag=DRAWER001) [cite: 2026-02-15]
        const params = new URLSearchParams(window.location.search);
        const tagId = params.get("tag") || "MAIN0001";

        // ì´ˆê¸°í™” ë¡œì§
        async function init() {
            const { data: { user } } = await supabase.auth.getUser();
            
            if (!user) {
                document.getElementById("auth-section").style.display = "block";
                return;
            }

            // íƒœê·¸ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° [cite: 2026-02-15]
            const { data: tag, error } = await supabase.from("tags").select("*").eq("id", tagId).single();

            if (tag && user.id === tag.owner_id) {
                document.getElementById("auth-section").style.display = "none";
                document.getElementById("main-card").style.display = "block";
                document.getElementById("drawer-name").innerText = tag.display_name;
                document.getElementById("new-name").value = tag.display_name;
                document.getElementById("edit-items").value = tag.items || "";
                renderItems(tag.items || "");
            } else {
                alert("ì ‘ê·¼ ê¶Œí•œì´ ì—†ê±°ë‚˜ ë“±ë¡ë˜ì§€ ì•Šì€ íƒœê·¸ì…ë‹ˆë‹¤.");
            }
        }

        // ë¬¼í’ˆ ëª©ë¡ ë Œë”ë§
        function renderItems(itemsStr) {
            const container = document.getElementById("display-container");
            container.innerHTML = "";
            const items = itemsStr.split(",").map(i => i.trim()).filter(i => i !== "");
            items.forEach(item => {
                const div = document.createElement("div");
                div.className = "item-card";
                div.innerText = "ğŸ“¦ " + item;
                container.appendChild(div);
            });
        }

        // [ê¸°ëŠ¥ 1] ë¡œê·¸ì¸(Magic Link)
        document.getElementById("login-btn").onclick = async () => {
            const email = document.getElementById("email-input").value;
            const { error } = await supabase.auth.signInWithOtp({
                email,
                options: { emailRedirectTo: window.location.href }
            });
            if (error) alert("ì˜¤ë¥˜: " + error.message);
            else alert("ì¸ì¦ ë©”ì¼ì„ ë³´ëƒˆìŠµë‹ˆë‹¤. ë©”ì¼í•¨ì˜ ë§í¬ë¥¼ í´ë¦­í•˜ì„¸ìš”.");
        };

        // [ê¸°ëŠ¥ 2] ì˜ìƒ ì—…ë¡œë“œ (Storage ì €ì¥) [cite: 2026-02-15]
        document.getElementById("upload-btn").onclick = async () => {
            const fileInput = document.getElementById("video-input");
            const status = document.getElementById("upload-status");
            if (!fileInput.files.length) return alert("ì˜ìƒì„ ë¨¼ì € ì´¬ì˜í•´ ì£¼ì„¸ìš”.");

            const file = fileInput.files[0];
            const { data: { user } } = await supabase.auth.getUser();
            const filePath = `${user.id}/${tagId}_${Date.now()}.mp4`;

            status.innerText = "ğŸš€ ì˜ìƒì„ ì „ì†¡ ì¤‘ì…ë‹ˆë‹¤...";
            const { error } = await supabase.storage.from('user_uploads').upload(filePath, file);

            if (error) {
                alert("ì „ì†¡ ì‹¤íŒ¨: " + error.message);
                status.innerText = "";
            } else {
                status.innerText = "âœ… ì „ì†¡ ì™„ë£Œ! AI ë¶„ì„ì„ ì‹œì‘í•©ë‹ˆë‹¤.";
                alert("ì˜ìƒì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. ê³§ ëª©ë¡ì´ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.");
            }
        };

        // [ê¸°ëŠ¥ 3] ì‹¤ì‹œê°„ ê²€ìƒ‰
        document.getElementById("search-input").oninput = (e) => {
            const word = e.target.value.toLowerCase();
            document.querySelectorAll(".item-card").forEach(card => {
                card.style.display = card.innerText.toLowerCase().includes(word) ? "flex" : "none";
            });
        };

        // [ê¸°ëŠ¥ 4] ëª©ë¡ ìˆ˜ë™ ì €ì¥
        document.getElementById("save-btn").onclick = async () => {
            const { data: { user } } = await supabase.auth.getUser();
            const { error } = await supabase.from("tags").update({ 
                display_name: document.getElementById("new-name").value,
                items: document.getElementById("edit-items").value 
            }).eq("id", tagId).eq("owner_id", user.id);
            
            if (!error) { alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."); location.reload(); }
            else alert("ì €ì¥ ì‹¤íŒ¨: " + error.message);
        };

        init();
    </script>
</body>
</html>
