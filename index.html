<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>ëª¨ë°”ì¼ ì›¹ ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: sans-serif; padding: 20px; line-height: 1.6; background: #f4f4f9; }
    .card { background: #fff; border: 1px solid #ddd; padding: 20px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .badge { background: #e0f7fa; color: #006064; padding: 4px 10px; border-radius: 8px; font-size: 13px; font-weight: bold; }
    #edit-box { display:none; margin-top: 20px; background: #fffde7; padding: 20px; border: 1px dashed #fbc02d; border-radius: 15px; }
    input, textarea { width: 100%; margin: 10px 0; padding: 12px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
    button { width: 100%; padding: 12px; background: #333; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; }
    .auth-input { background: #fff; border: 2px solid #000; }
  </style>
</head>
<body>
  <div class="card">
    <span class="badge" id="date-label">ë‚ ì§œ í™•ì¸ ì¤‘...</span>
    <h2 id="title" style="margin: 10px 0;">ë¡œë”© ì¤‘...</h2>
    <p><strong>ğŸ“¦ í¬í•¨ëœ ë¬¼í’ˆ:</strong></p>
    <div id="items-list" style="white-space: pre-wrap; background: #fdfdfd; padding: 10px; border-radius: 8px;">ë¬¼í’ˆ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤.</div>
  </div>
  
  <div id="auth-section" style="margin-top:20px;">
    <p style="font-size: 14px; color: #666;">ê´€ë¦¬ìë¼ë©´ ì´ë©”ì¼ì„ ì…ë ¥í•´ ì¸ì¦í•˜ì„¸ìš”.</p>
    <input type="email" id="email-input" class="auth-input" placeholder="ì´ë©”ì¼ ì£¼ì†Œ ì…ë ¥">
    <button id="login-btn">ì¸ì¦ ë©”ì¼ ë°›ê¸°</button>
    <p id="user-info" style="color: #007bff; font-size: 13px; margin-top: 10px; font-weight: bold;"></p>
  </div>

  <div id="edit-box">
    <p style="color: #d32f2f;">âœ… <strong>ë³´ì•ˆ ì¸ì¦ ì™„ë£Œ:</strong> ê´€ë¦¬ ê¶Œí•œì´ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
    <input type="text" id="new-name" placeholder="ì„œë ì´ë¦„ ìˆ˜ì •">
    <textarea id="new-items" rows="4" placeholder="ë¬¼í’ˆ ëª©ë¡ ìˆ˜ì • (ì˜ˆ: ë§ì¹˜, ë“œë¼ì´ë²„)"></textarea>
    <button id="update-btn" style="background: #2e7d32;">ì •ë³´ ì—…ë°ì´íŠ¸</button>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm"

    // [í•„ë…] ì‚¬ìš©ìë‹˜ì˜ ì§„ì§œ í‚¤(eyJ...)ë¥¼ ì•„ë˜ í°ë”°ì˜´í‘œ ì•ˆì— ê¼­ ë‹¤ì‹œ ë„£ì–´ì£¼ì„¸ìš”!
    const SUPABASE_URL = "https://tqhtggusphhcsygiitrv.supabase.co"
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRxaHRnZ3VzcGhoY3N5Z2lpdHJ2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEwNDMxMTMsImV4cCI6MjA4NjYxOTExM30.HXA2GbucJPkt3LFl9_JpLiwUQvI95QNEDeQWzQ9i-pc"
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY)

    const titleEl = document.getElementById("title");
    const dateEl = document.getElementById("date-label");
    const itemsEl = document.getElementById("items-list");
    const editBox = document.getElementById("edit-box");
    const userInfoEl = document.getElementById("user-info");
    const emailInput = document.getElementById("email-input");

    let tagId = new URLSearchParams(window.location.search).get("tag");

    // 1. ì´ë©”ì¼ ë¡œê·¸ì¸ ê¸°ëŠ¥ (ë§ˆë²• ë§í¬ ë°©ì‹)
    document.getElementById("login-btn").onclick = async () => {
      const email = emailInput.value;
      if (!email) return alert("ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
      
      const { error } = await supabase.auth.signInWithOtp({
        email: email,
        options: { emailRedirectTo: window.location.href } // ë¡œê·¸ì¸ í›„ í˜„ì¬ í˜ì´ì§€ë¡œ ëŒì•„ì˜´
      });
      
      if (error) alert("ì˜¤ë¥˜: " + error.message);
      else alert("ì´ë©”ì¼ë¡œ ë¡œê·¸ì¸ ë§í¬ë¥¼ ë³´ëƒˆìŠµë‹ˆë‹¤! ë©”ì¼í•¨ì„ í™•ì¸í•˜ì„¸ìš”.");
    };

    // 2. ì •ë³´ ìˆ˜ì • ê¸°ëŠ¥
    document.getElementById("update-btn").onclick = async () => {
      const { error } = await supabase.from("tags").update({ 
        display_name: document.getElementById("new-name").value,
        items: document.getElementById("new-items").value 
      }).eq("id", tagId);
      
      if (error) alert("ìˆ˜ì • ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
      else { alert("ìˆ˜ì • ì„±ê³µ!"); location.reload(); }
    };

    // 3. í˜ì´ì§€ ì´ˆê¸°í™”
    async function init() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!tagId) return titleEl.innerText = "íƒœê·¸ ì—†ìŒ";

      const { data: tag } = await supabase.from("tags").select("*").eq("id", tagId).single();

      if (tag) {
        titleEl.innerText = tag.display_name || "ì´ë¦„ ì—†ëŠ” ì„œë";
        itemsEl.innerText = tag.items || "ë“±ë¡ëœ ë¬¼í’ˆì´ ì—†ìŠµë‹ˆë‹¤.";
        dateEl.innerText = "ìƒì„± ë‚ ì§œ: " + new Date(tag.created_at).toLocaleDateString();
        
        // ë³´ì•ˆ ì²´í¬: ë¡œê·¸ì¸í•œ IDì™€ DBì˜ owner_id ëŒ€ì¡°
        if (user) {
            userInfoEl.innerText = "í˜„ì¬ ì ‘ì† ê³„ì •: " + user.email;
            if (user.id === tag.owner_id) {
                editBox.style.display = "block";
                document.getElementById("new-name").value = tag.display_name;
                document.getElementById("new-items").value = tag.items || "";
                document.getElementById("auth-section").style.display = "none";
            } else {
                userInfoEl.innerText += " (ê¶Œí•œ ì—†ìŒ)";
            }
        }
      }
    }
    init();
  </script>
</body>
</html>
