<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>ì°¾ì•˜ë‹¤! - ì§€ëŠ¥í˜• ë¬¼í’ˆ ê´€ë¦¬</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f8f9fa; color: #333; }
        .card { background: #fff; padding: 20px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: none; margin-bottom: 20px; }
        #auth-section { background: #fff; padding: 30px; border-radius: 15px; border: 2px solid #333; text-align: center; }
        input { width: 100%; margin: 10px 0; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        button { width: 100%; padding: 14px; background: #333; color: #fff; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .item-card { padding: 15px; border-bottom: 1px solid #eee; display: flex; align-items: center; background: #fff; }
        .upload-area { background: #f0f4f8; padding: 15px; border-radius: 10px; border: 2px dashed #007bff; margin: 20px 0; }
        .status-msg { font-size: 12px; color: #007bff; margin-top: 5px; font-weight: bold; }
    </style>
</head>
<body>

    <div id="auth-section">
        <h2>ğŸ”’ ë³´ì•ˆ ì ‘ì†</h2>
        <input type="email" id="email-input" placeholder="ì´ë©”ì¼ ì…ë ¥">
        <input type="password" id="password-input" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
        <button id="password-login-btn">ë¹„ë°€ë²ˆí˜¸ë¡œ ë°”ë¡œ ì ‘ì†</button>
    </div>

    <div id="main-card" class="card">
        <h2 id="drawer-name">ë¡œë”© ì¤‘...</h2>
        <input type="text" id="search-input" placeholder="ğŸ” ì–´ë–¤ ë¬¼ê±´ì„ ì°¾ìœ¼ì‹œë‚˜ìš”?">
        <div id="display-container"></div>

        <div class="upload-area">
            <p>ğŸ“¸ <strong>ì„œë ì•ˆ ì´¬ì˜/ì„ íƒí•˜ê¸°</strong></p>
            <input type="file" id="media-input" accept="image/*, video/*" style="margin-bottom:10px;">
            <button id="upload-btn" style="background:#007bff;">ë°ì´í„° ì „ì†¡í•˜ì—¬ ëª©ë¡ ë§Œë“¤ê¸°</button>
            <p id="upload-status" class="status-msg"></p>
        </div>

        <div style="margin-top:25px; border-top:2px dashed #eee; padding-top:15px;">
            <p>ğŸ› ï¸ <strong>ê´€ë¦¬ì ìˆ˜ì •</strong></p>
            <input type="text" id="new-name" placeholder="ì„œë ì´ë¦„ ìˆ˜ì •">
            <textarea id="edit-items" rows="5" style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd;" placeholder="ë¬¼í’ˆ ëª©ë¡"></textarea>
            <button id="save-btn" style="background:#2e7d32; margin-top:10px;">ëª©ë¡ ì €ì¥í•˜ê¸°</button>
        </div>
    </div>

    <script type="module">
        import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm"
        const supabase = createClient("https://tqhtggusphhcsygiitrv.supabase.co", "sb_publishable_D9nhmN5ZlyApSrHHasyQ3w_O7Kdmssq")
        
        const params = new URLSearchParams(window.location.search);
        const tagId = params.get("tag") || "MAIN0001";

        async function init() {
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) { document.getElementById("auth-section").style.display = "block"; return; }

            const { data: tag } = await supabase.from("tags").select("*").eq("id", tagId).single();
            if (tag && user.id === tag.owner_id) {
                document.getElementById("auth-section").style.display = "none";
                document.getElementById("main-card").style.display = "block";
                document.getElementById("drawer-name").innerText = tag.display_name;
                document.getElementById("new-name").value = tag.display_name;
                document.getElementById("edit-items").value = tag.items || "";
                renderItems(tag.items || "");
            } else {
                alert("ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
                document.getElementById("auth-section").style.display = "block";
            }
        }

        function renderItems(itemsStr) {
            const container = document.getElementById("display-container");
            container.innerHTML = "";
            const items = itemsStr.split(",").map(i => i.trim()).filter(i => i !== "");
            items.forEach(item => {
                const div = document.createElement("div");
                div.className = "item-card";
                div.innerText = "ğŸ“¦ " + item;
                container.appendChild(div);
            });
        }

        document.getElementById("password-login-btn").onclick = async () => {
            const email = document.getElementById("email-input").value;
            const password = document.getElementById("password-input").value;
            const { error } = await supabase.auth.signInWithPassword({ email, password });
            if (error) alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: " + error.message);
            else location.reload();
        };

        // ë°ì´í„° ì „ì†¡ ë¡œì§ ìˆ˜ì • (ì‚¬ì§„/ì˜ìƒ ìë™ êµ¬ë¶„ ì €ì¥)
        document.getElementById("upload-btn").onclick = async () => {
            const fileInput = document.getElementById("media-input");
            const status = document.getElementById("upload-status");
            if (!fileInput.files.length) return alert("ì‚¬ì§„ì´ë‚˜ ì˜ìƒì„ ì„ íƒí•˜ì„¸ìš”.");

            const file = fileInput.files[0];
            const { data: { user } } = await supabase.auth.getUser();
            
            // íŒŒì¼ í™•ì¥ìì— ë”°ë¼ ê²½ë¡œ ìë™ ìƒì„±
            const ext = file.name.split('.').pop();
            const filePath = `${user.id}/${tagId}_${Date.now()}.${ext}`;

            status.innerText = "ğŸš€ ë°ì´í„°ë¥¼ ì „ì†¡ ì¤‘ì…ë‹ˆë‹¤...";
            const { error } = await supabase.storage.from('user_uploads').upload(filePath, file);

            if (error) {
                alert("ì „ì†¡ ì‹¤íŒ¨: " + error.message);
                status.innerText = "";
            } else {
                status.innerText = "âœ… ì „ì†¡ ì™„ë£Œ! AI ë¶„ì„ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤.";
                alert("ì„±ê³µì ìœ¼ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
            }
        };

        init();
    </script>
</body>
</html>
